<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../../bower_components/paper-radio-group/paper-radio-group.html">

<dom-module id="perpetuo-criteo-target-selector">
  <template>
    <style>
    :host {
      display: flex;
      flex-direction: column;
      padding: 0;
    }
    paper-checkbox {
      margin-bottom: 0.5em;
    }
    </style>
    <template is="dom-repeat" items="[[targets]]">
      <paper-checkbox disabled="[[disabled]]" dc="[[item.code]]" checked="{{item.checked}}">[[item.name]]</paper-checkbox>
    </template>
  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'perpetuo-criteo-target-selector',

      properties: {
        targets: Array,
        disabled: { type: Boolean, reflectToAttribute: true }
      },

      clear() {
        this.targets = this.targets.map(_ => ({code: _.code, name: _.name}));
      },

      get value() {
        return this.targets.filter(_ => _.checked).map(_ => _.code);
      }
    });
  } ())
  </script>
</dom-module>

<dom-module id="perpetuo-criteo-target-expression-editor">
  <template>
    <style>
    :host {
      display: flex;
      flex-direction: column;
    }
    .dc-selector {
      display: flex;
      flex-direction: column;
    }
    perpetuo-criteo-target-selector {
      margin-left: 3em;
    }
    </style>
    <template is="dom-if" if="[[!targets.length]]">
      <p style="font-size:16px; margin:0 0 0.5em 0;">On all configured targets</p>
    </template>
    <template is="dom-if" if="[[targets.length]]">
      <p style="font-size:16px; margin:0 0 0.5em 0;">On:</p>
      <paper-radio-group class="dc-selector" selected="{{dcSelectionMode}}">
        <paper-radio-button name="allConfigured">All configured targets</paper-radio-button>
        <paper-radio-button name="freeSelection">Free selection</paper-radio-button>
        <perpetuo-criteo-target-selector targets="[[targets]]" disabled="[[!isFreeSelectionMode]]"></perpetuo-criteo-target-selector>
      </paper-radio-group>
    </template>
  </template>
  <script>
  Polymer({
    is: 'perpetuo-criteo-target-expression-editor',

    properties: {
      productName: { type: String, observer: 'onProductNameChanged' },

      dcSelectionMode: { type: String, value: 'allConfigured' },
      isFreeSelectionMode: {type: Boolean, computed: 'computeIsFreeSelectionMode(dcSelectionMode)'},

      targets: Array
    },

    attached() {
      this.client = new Perpetuo.Client();
    },

    onProductNameChanged(productName) {
      if (productName)
        this.client.fetchTargetsForProduct(productName).then(targets => {
          this.targets = targets;
        });
      else
        this.targets = [];
    },

    computeIsFreeSelectionMode(dcSelectionMode) {
      return dcSelectionMode === 'freeSelection';
    },

    clear() {
      const targetSelector = this.$$('perpetuo-criteo-target-selector');
      if (targetSelector)
        targetSelector.clear();
      this.dcSelectionMode = 'allConfigured';
    },

    get value() {
      switch (this.dcSelectionMode) {
        case 'allConfigured':
          return '*';
        case 'freeSelection':
          return this.$$('perpetuo-criteo-target-selector').value;
      }
      throw 'Should not be there';
    }
  });
  </script>
</dom-module>

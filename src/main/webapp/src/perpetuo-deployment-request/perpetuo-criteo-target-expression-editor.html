<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../../bower_components/paper-radio-group/paper-radio-group.html">

<dom-module id="perpetuo-criteo-data-center-selector">
  <template>
    <style>
    :host {
      display: flex;
      flex-direction: column;
      padding: 0;
    }
    paper-checkbox {
      margin-bottom: 0.5em;
    }
    </style>
    <template is="dom-repeat" items="[[dataCenters]]">
      <paper-checkbox disabled="[[disabled]]" dc="[[item.code]]" checked="{{item.checked}}">[[item.name]]</paper-checkbox>
    </template>
  </template>
  <script>
  (function() {
    'use strict';

    function createDefaultDataCenterModelView() {
      return [
        { code: 'par', name: 'Paris' },
        { code: 'am5', name: 'Amsterdam' },
        { code: 'ny8', name: 'New York' },
        { code: 'sv6', name: 'Sunnyvale' },
        { code: 'va1', name: 'Ashburn' },
        { code: 'hk5', name: 'Hong Kong' },
        { code: 'sh5', name: 'Shanghai' },
        { code: 'ty5', name: 'Tokyo' }
      ];
    }

    Polymer({
      is: 'perpetuo-criteo-data-center-selector',

      properties: {
        dataCenters: { type: Array, value: createDefaultDataCenterModelView },
        disabled: { type: Boolean, reflectToAttribute: true }
      },

      clear() {
        this.dataCenters = createDefaultDataCenterModelView();
      },

      get value() {
        return this.dataCenters.filter(_ => _.checked).map(_ => _.code);
      }
    });
  } ())
  </script>
</dom-module>

<dom-module id="perpetuo-criteo-target-expression-editor">
  <template>
    <style>
    :host {
      display: flex;
      flex-direction: column;
    }
    .dc-selector {
      display: flex;
      flex-direction: column;
    }
    perpetuo-criteo-data-center-selector {
      margin-left: 3em;
    }
    </style>
    <template is="dom-if" if="[[productTypeEquals(productType, 'hadoop')]]">
      <p style="font-size:16px; margin:0 0 0.5em 0;">Target: All configured gateways</p>
    </template>
    <template is="dom-if" if="[[productTypeEquals(productType, 'marathon')]]">
      <p style="font-size:16px; margin:0 0 0.5em 0;">Target</p>
      <paper-radio-group class="dc-selector" selected="{{dcSelectionMode}}">
        <paper-radio-button name="allConfigured">All configured data centers</paper-radio-button>
        <paper-radio-button name="freeSelection">Free selection</paper-radio-button>
        <perpetuo-criteo-data-center-selector disabled="[[!isFreeSelectionMode]]"></perpetuo-criteo-data-center-selector>
      </paper-radio-group>
    </template>
  </template>
  <script>
  Polymer({
    is: 'perpetuo-criteo-target-expression-editor',

    properties: {
      productName: { type: String, observer: 'onProductNameChanged' },
      productType: String,

      dcSelectionMode: { type: String, value: 'allConfigured' },
      isFreeSelectionMode: {type: Boolean, computed: 'computeIsFreeSelectionMode(dcSelectionMode)'},
    },

    onProductNameChanged() {
      if (this.productName) {
        fetch(`http://moab.criteois.lan/products/${this.productName}/manifest.json`).then(_ => _.json()).then(productManifest => {
          this.productType = productManifest.type;
        });
      } else {
        this.productType = null;
      }
    },

    productTypeEquals(productType, t) {
      return this.productType === t;
    },

    computeIsFreeSelectionMode(dcSelectionMode) {
      return dcSelectionMode === 'freeSelection';
    },

    clear() {
      const dataCenterSelector = this.$$('perpetuo-criteo-data-center-selector');
      if (dataCenterSelector)
        dataCenterSelector.clear();
      this.dcSelectionMode = 'allConfigured';
    },

    get value() {
      switch (this.dcSelectionMode) {
        case 'allConfigured':
          return '*';
        case 'freeSelection':
          return this.$$('perpetuo-criteo-data-center-selector').value;
      }
      throw 'Should not be there';
    }
  });
  </script>
</dom-module>

<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">

<link rel="import" href="../perpetuo-deployment-request/perpetuo-deployment-request-target-selector.html">

<dom-module id="perpetuo-deployment-request-step-edition-dialog">
  <template>
    <style>
    #dialog {
      width: 80%;
    }
    h1 {
      margin: 0;
      padding-top: 24px;
      min-height: 40px;
      background-color: var(--primary-color);
      color: #fff;
      font-size: 22px;
      font-weight: 100;
    }
    </style>
    <paper-dialog id="dialog" with-backdrop>
      <h1>New Deployment Step</h1>
      <paper-dialog-scrollable>
        <paper-input label="Name" value="{{name}}"></paper-input>
        <perpetuo-deployment-request-target-selector id="targetSelector" product-name="[[productName]]"
                                                     on-selected-targets-changed="updateSelectedTargets"></perpetuo-deployment-request-target-selector>
      </paper-dialog-scrollable>
      <div class="buttons">
        <paper-button id="create" dialog-confirm disabled="[[!selectedTargets]]">Add</paper-button>
        <paper-button id="cancel" dialog-dismiss>Cancel</paper-button>
      </div>
    </paper-dialog>
  </template>
  <script>
  (function () {
    class PerpetuoDeploymentRequestStepEditionDialog extends Polymer.Element {
      static get is() { return 'perpetuo-deployment-request-step-edition-dialog'; }

      static get properties() {
        return {
          productName: String,

          name: {type: String, value: ''},
          selectedTargets: {type: Object, value: null}
        }
      }

      clear() {
        if (this.$) {
          this.name = '';
          this.$.targetSelector.clear();
          this.selectedTargets = null;
        }
      }

      updateSelectedTargets() {
        this.selectedTargets = this.$.targetSelector.selectedTargets;
        this.$.dialog.notifyResize();
      }

      edit() {
        return new Promise((resolve, reject) => {
          const dialog = this.$.dialog;
          const onOpenedChanged = (e) => {
            if (!e.detail.value) {
              dialog.removeEventListener('opened-changed', onOpenedChanged);
              if (dialog.closingReason.confirmed) {
                resolve({name: this.name, target: this.selectedTargets});
              } else {
                reject();
              }
            }
          };
          dialog.addEventListener('opened-changed', onOpenedChanged);
          dialog.open();
        });
      }
    }
    customElements.define(PerpetuoDeploymentRequestStepEditionDialog.is, PerpetuoDeploymentRequestStepEditionDialog);
  } ());
  </script>
</dom-module>

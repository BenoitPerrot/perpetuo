<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">

<link rel="import" href="../perpetuo-client/perpetuo-client.html">

<dom-module id="perpetuo-deployment-request-entry">
  <template>
    <style>
    :host {
      display: flex;
      flex-direction: column;
      margin-bottom: 5px;
      border-bottom: solid 1px #ddd;
    }

    div.heading {
      display: flex;
      align-items: center;
      padding: 0.5em 0;
      height: 50px;
    }

    span {
      display: inline-block;
    }

    span.product-name {
      font-size: 26px;
      width: 40%;
      padding-right: 40px;
      box-sizing: border-box;
    }
    iron-icon {
      margin-left: 10px;
      width: 16px;
      height: 16px;
      vertical-align: bottom;
    }
    a:not(:hover) span.product-name iron-icon {
      display: none;
    }
    span.version {
      font-size: 20px;
      width: 10%;
    }
    span.ratio {
      vertical-align: super;
      font-size: smaller;
      color: gray;
    }
    span.target {
      width: 20%;
    }
    span.creation-date {
      width: 20%;
    }
    div.state {
      width: 10%;
      display: flex;
      justify-content: flex-end;
    }
    div.state > span {
      border-radius: 3px;
      padding: 0.7em 0.57em;
      text-transform: uppercase;
      background-color: #f5f5f5;
    }
    div.state > span.succeeded {
      color: #fff;
      background-color: #0f9d58;
    }
    div.state > span.failed, div.state > span.init-failed {
      color: #fff;
      background-color: #f44336;
    }
    div.state > span.in-progress {
      color: #fff;
      background: repeating-linear-gradient(-45deg, #009688, #009688 10px, #26a69a 10px, #26a69a 20px);
    }

    a {
      text-decoration: none;
      color: initial;
    }
    </style>
    <a href$="/deployment-requests/[[data.id]]">
      <div class="heading">
        <span class="product-name">[[data.productName]]<iron-icon icon="launch"></iron-icon></span>
        <span class="version">
          <template is="dom-repeat" items="[[shortVersion]]">
            [[item.value]]<template is="dom-if" if="[[item.ratio]]">&nbsp;<span class="ratio">[[asPercentage(item.ratio)]]%</span></template><br/>
          </template>
        </span>
        <span class="target">[[data.target]]</span>
        <span class="creation-date">[[data.dateString]]</span>
        <div class="state">
          <span class$="[[toCssClasses(data.state)]]">[[humanReadable(data.state)]]</span>
        </div>
      </div>
    </a>
  </template>
  <script>
  Polymer({
    is: 'perpetuo-deployment-request-entry',

    properties: {
      data: Object,
      shortVersion: { type: Array, computed: 'computeShortVersion(data)' },
    },

    computeShortVersion(data) {
      const uniformed = Array.isArray(data.version) ? data.version : [{value: data.version}];
      return uniformed.map(version => ({
        value: (expr => expr.length > 10 ? expr.slice(0, 7) + "..." : expr)(version.value.toString()),
        ratio: version.ratio
      }));
    },

    asPercentage(ratio) {
      return ratio * 100;
    },

    humanReadable(actionName) {
      return actionName.replace(/([A-Z])/g, ' $1');
    },

    toCssClasses(actionName) {
      return actionName.replace(/([A-Z])/g, '-$1').toLowerCase();
    }
  });
  </script>
</dom-module>

<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">

<link rel="import" href="../perpetuo-client/perpetuo-client.html">
<link rel="import" href="../perpetuo-deployment-request/perpetuo-deployment-operation.html">

<dom-module id="perpetuo-deployment-request-entry">
  <style>
  :host {
    display: flex;
    flex-direction: column;
    margin-bottom: 5px;
    border-bottom: solid 1px #ddd;
  }

  div.heading {
    display: flex;
    align-items: center;
    padding: 0.5em 0;
    height: 50px;
  }

  span {
    display: inline-block;
  }

  span.product-name {
    font-size: 26px;
    width: 30%;
    padding-right: 40px;
    box-sizing: border-box;
  }
  span.product-name > span {
    cursor: pointer;
  }
  span.product-name > paper-icon-button {
    margin-left: -40px;
  }
  span.version {
    font-size: 20px;
    width: 10%;
  }
  span.target {
    width: 20%;
  }
  span.creator {
    width: 10%;
  }
  span.creation-date {
    width: 20%;
  }
  div.state {
    width: 10%;
    display: flex;
    justify-content: flex-end;
  }
  div.state > paper-material {
    border-radius: 3px;
    padding: 0.7em 0.57em;
    text-transform: uppercase;
  }
  div.state.success > paper-material {
    color: #fff;
    background-color: #0f9d58;
  }
  div.state.failed > paper-material {
    color: #fff;
    background-color: #f44336;
  }
  div.state.in-progress > paper-material {
    color: #fff;
    background: repeating-linear-gradient(-45deg, #009688, #009688 10px, #26a69a 10px, #26a69a 20px);
  }

  div.comment {
    margin: 0.5em 2em;
    background-color: #eee;
    border: solid 1px #ddd;
    padding-left: 1em;
  }

  div.comment > p {
    margin: 0;
  }

  div.operations {
    display: flex;
    flex-direction: column;
    padding: 0 0 1em 1em;
  }
  </style>
  <template>
    <div class="heading">
      <span class="product-name"><paper-icon-button icon="[[expanderIcon(expanded, hasMore)]]" disabled="[[!hasMore]]" on-tap="toggle"></paper-icon-button><span on-tap="toggle">[[data.productName]]</span></span>
      <span class="version">[[data.version]]</span>
      <span class="target">[[data.target]]</span>
      <span class="creator">[[data.creator]]</span>
      <span class="creation-date">[[data.dateString]]</span>
      <div class$="state [[state]]">
        <template is="dom-if" if="[[isWaitingForApproval(state)]]">
          <paper-button on-tap="onStartTap" raised>Start!</paper-button>
        </template>
        <template is="dom-if" if="[[!isWaitingForApproval(state)]]">
          <paper-material>[[state]]</paper-material>
        </template>
      </div>
    </div>
    <iron-collapse opened="[[expanded]]">
      <div class="comment" hidden$="[[!data.comment]]">
        <p hidden$="[[!comment.description]]">[[comment.description]]</p>
        <p hidden$="[[!comment.ticket]]">JIRA: <a href="[[comment.ticket.url]]">[[comment.ticket.reference]]</a></p>
      </div>
      <div class="operations">
        <template is="dom-repeat" items="[[data.operations]]">
          <paper-card>
            <perpetuo-deployment-operation data="[[item]]"></perpetuo-deployment-operation>
          </paper-card>
        </template>
      </div>
    </iron-collapse>
  </template>
  <script>
  function aggregateOperationState(operation) {
    const isFinished = operation.executions.every(_ => _.state !== 'pending' && _.state !== 'running');
    const hasFailures = operation.executions.some(_ => _.state === 'initFailed') ||
                        arrayifyTargetStatus(operation.targetStatus).some(_ => _.code !== 'success');
    return { isFinished: isFinished, hasFailures: hasFailures };
  }

  Polymer({
    is: 'perpetuo-deployment-request-entry',

    properties: {
      data: { type: Object, value: () => {} },
      state: { type: String, computed: 'computeState(data)' },
      expanded: { type: Boolean, value: false },
      hasMore: { type: Boolean, computed: 'computeHasMore(data)' },
      comment: { type: Object, computed: 'computeComment(data)' }
    },

    toggle() {
      this.expanded = !this.expanded;
    },
    expanderIcon(expanded, hasMore) {
      return hasMore ? (expanded ? 'expand-less' : 'expand-more') : '';
    },

    computeState(data) {
      if (0 < data.operations.length) {
        const aggregate = data.operations.map(aggregateOperationState);
        const isFinished = aggregate.every(_ => _.isFinished);
        const hasFailures = aggregate.some(_ => _.hasFailures);
        if (isFinished)  {
          return hasFailures ? 'failed' : 'success';
        } else {
          return 'in-progress' + (hasFailures ? ' (with failures)' : '');
        }
      } else {
        return 'waiting-for-approval';
      }
    },
    isWaitingForApproval(state) {
      return state === 'waiting-for-approval';
    },

    computeHasMore(data) {
      return data.comment || 0 < data.operations.length;
    },

    computeComment(data) {
      const fields = data.comment.split("ticket: ");
      let ret = { description: fields[0] };
      if (fields[1])
        ret.ticket = { url: fields[1], reference: fields[1].split("/").splice(-1)[0] };
      return ret;
    },

    onStartTap() {
      new Perpetuo.Client().startDeploymentRequest(this.data.id);
    }
  });
  </script>
</dom-module>

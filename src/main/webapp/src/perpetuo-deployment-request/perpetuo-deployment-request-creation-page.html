<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="../perpetuo-app/perpetuo-app-toolbar.html">
<link rel="import" href="../perpetuo-client/perpetuo-client.html">
<link rel="import" href="../perpetuo-deployment-request/perpetuo-deployment-request-comment-editor.html">
<link rel="import" href="../perpetuo-deployment-request/perpetuo-deployment-request-creation-error.html">
<link rel="import" href="../perpetuo-deployment-request/perpetuo-deployment-request-creator.html">
<link rel="import" href="../perpetuo-deployment-request/perpetuo-deployment-request-product-selector.html">
<link rel="import" href="../perpetuo-deployment-request/perpetuo-deployment-request-strategy-selector.html">
<link rel="import" href="../perpetuo-deployment-request/perpetuo-deployment-request-version-selector.html">
<link rel="import" href="../perpetuo-stepper/perpetuo-step.html">
<link rel="import" href="../perpetuo-stepper/perpetuo-stepper.html">

<dom-module id="perpetuo-deployment-request-creation-page">
  <template>
    <style>
    :host {
      display: flex;
      flex-direction: column;
    }

    #stepper {
      flex: 1;
      width: 50%;
      margin-left: 64px;
    }
    </style>

    <perpetuo-app-toolbar>
      <div slot="title" style="display: flex; align-items: center;">
        <a href="/deployment-requests"><paper-icon-button icon="arrow-back" style="color:#fff"></paper-icon-button></a>
        <span style="margin-left: 20px;">New Deployment Request</span>
      </div>
    </perpetuo-app-toolbar>

    <perpetuo-stepper id="stepper" on-stepper-completed="onStepperCompleted">

      <perpetuo-step id="productSelectionStep" label="[[productSelectionStepLabel]]" complete-label="Continue" no-cancel-button
                     on-step-enter="onProductSelectionStepEnter" on-step-leave="onProductSelectionStepLeave"
                     complete-disabled="[[!selectedProductName]]">
        <perpetuo-deployment-request-product-selector slot="content" id="productSelector"
                                                      products="[[products]]" selected-product-name="{{selectedProductName}}"></perpetuo-deployment-request-product-selector>
      </perpetuo-step>

      <perpetuo-step id="versionSelectionStep" label="[[versionSelectionStepLabel]]" complete-label="Continue" cancel-label="Back"
                     on-step-enter="onVersionSelectionStepEnter" on-step-leave="onVersionSelectionStepLeave">
        <perpetuo-deployment-request-version-selector slot="content" id="versionSelector"
                                                      product-name="[[selectedProductName]]" selected-version="{{selectedVersion}}"></perpetuo-deployment-request-version-selector>
      </perpetuo-step>

      <perpetuo-step label="Select Strategy" complete-label="Continue" cancel-label="Back"
                     complete-disabled="[[!selectedStrategy.length]]">
        <perpetuo-deployment-request-strategy-selector slot="content" product-name="[[selectedProductName]]" id="strategySelector"
                                                       on-selected-strategy-changed="updateSelectedStrategy"></perpetuo-deployment-request-strategy-selector>
      </perpetuo-step>

      <perpetuo-step label="Comment" cancel-label="Back" complete-label="Create"
                     on-step-enter="onCommentEditionStepEnter" on-step-leave="onCommentEditionStepLeave">
        <perpetuo-deployment-request-comment-editor slot="content" id="commentEditor"></perpetuo-deployment-request-comment-editor>
      </perpetuo-step>
    </perpetuo-stepper>

    <perpetuo-deployment-request-creation-error id="errorDialog"></perpetuo-deployment-request-creation-error>
  </template>
  <script>
  (function () {
    class PerpetuoDeploymentRequestCreationPage extends Polymer.Element {
      static get is() { return 'perpetuo-deployment-request-creation-page'; }

      static get properties() {
        return {
          login: String,
          active: {type: Boolean, observer: 'onActiveChanged'},
          products: { type: Array, value: () => [] },
          productSelectionStepLabel: {type: String, value: 'Select Product'},
          versionSelectionStepLabel: {type: String, value: 'Select Version'},
          selectedProductName: { type: String, observer: 'onSelectedProductNameChanged'},
          selectedVersion: String,
          selectedStrategy: {type: Array, value: () => []},
        };
      }

      restoreDefaultValue(propertyName) {
        this[propertyName] = this.constructor.properties[propertyName].value;
      }

      onActiveChanged() {
        this.clear();
        if (this.active) {
          this.client.fetchIdentity()
              .then(login => {
                if (login) {
                  this.login = login;
                } else {
                  this.client.redirectToAuthorizeURL(window);
                }
              })
          this.client.fetchProducts()
              .then(products => { this.products = products; });
        }
      }

      onProductSelectionStepEnter(e) {
        this.restoreDefaultValue('productSelectionStepLabel');
        this.$.productSelector.disabled = false;
      }

      onProductSelectionStepLeave(e) {
        this.$.productSelector.disabled = true;
        this.productSelectionStepLabel = `Selected Product: ${this.selectedProductName}`;
      }

      onVersionSelectionStepEnter(e) {
        this.restoreDefaultValue('versionSelectionStepLabel');
        this.$.versionSelector.disabled = false;
      }

      onVersionSelectionStepLeave(e) {
        this.$.versionSelector.disabled = true;
        this.versionSelectionStepLabel = `Selected Version: ${this.selectedVersion}`;
      }

      onSelectedProductNameChanged(name) {
        this.$.versionSelector.clear();
        if (name) {
          this.$.productSelectionStep.fireStepCompleted();
        }
      }

      updateSelectedStrategy() {
        this.selectedStrategy = this.$.strategySelector.selectedStrategy;
      }

      onCommentEditionStepEnter(e) {
        this.$.commentEditor.disabled = false;
      }

      onCommentEditionStepLeave(e) {
        this.$.commentEditor.disabled = true;
      }

      constructor() {
        super();
        this.client = new Perpetuo.Client();
      }

      onStepperCompleted() {
        this.create();
      }

      create() {
        new Perpetuo.DeploymentRequestCreator()
                    .create(this.selectedProductName,
                            this.selectedVersion,
                            this.selectedStrategy,
                            this.$.commentEditor.value)
                    .then(_ => _.json())
                    .then(o => {
                      window.location.replace(`/deployment-requests/${o.id}`);
                    })
                    .catch(e => {
                      this.$.errorDialog.errors = e.detail.errors;
                      this.$.errorDialog.open();
                    });
      }

      clear() {
        if (this.$) {
          this.$.stepper.reset();
          this.$.productSelector.clear();
          this.$.versionSelector.disabled = true;
          this.$.versionSelector.clear();
          this.$.strategySelector.clear();
          this.$.commentEditor.clear();
        }
      }
    }

    customElements.define(PerpetuoDeploymentRequestCreationPage.is, PerpetuoDeploymentRequestCreationPage);
  } ());
  </script>
</dom-module>

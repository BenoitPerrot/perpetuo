<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/paper-card/paper-card.html">

<link rel="import" href="../perpetuo-deployment-request/perpetuo-conflicting-deployment-requests.html">
<link rel="import" href="../perpetuo-deployment-request/perpetuo-deployment-operation.html">
<link rel="import" href="../perpetuo-markdown/perpetuo-markdown-viewer.html">

<dom-module id="perpetuo-deployment-request">
  <template>
    <style>
    .body {
      display: flex;
      flex-direction: column;
      padding: 20px;
    }
    .body > h1 {
      border-bottom: solid 1px #ddd;
      margin-top: 0;
      padding: 0 0 20px 0;
      font-weight: normal;
      display: flex;
      align-items: center;
    }

    .version {
      margin-left: 2em;
    }
    .ratio {
      vertical-align: super;
      font-size: smaller;
      color: gray;
    }

    .state {
      border-radius: 3px;
      margin-left: 2em;
      padding: 0.7em 0.57em;
      text-transform: uppercase;
      background-color: #f5f5f5;
    }
    .state.deployed {
      color: #fff;
      background-color: #0f9d58;
    }
    .state.failed, .state.flopped, .state.reverted {
      color: #fff;
      background-color: #f44336;
    }
    .state.in-progress {
      color: #fff;
      background: repeating-linear-gradient(-45deg, #009688, #009688 10px, #26a69a 10px, #26a69a 20px);
    }

    .actions {
      margin: 0 1em 1em 0;
    }

    #general, #target, #operations {
      padding: 24px 16px;
    }

    paper-card {
      margin-bottom: 1em;
    }
    paper-card h1, paper-card h2 {
      margin: 0;
      font-weight: normal;
    }
    paper-card h1 {
      font-size: 24px;
    }

    .cancel {
      background-color: #f44336;
      color: #fff;
    }
    .revert {
      background: #26a69a;
      color: #fff;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }
    table th {
      font-weight: 500;
      color: #757575;
      text-align: left;
    }
    table td {
      color: hsl(0, 0%, 13%);
    }
    table tr {
      height: 42px;
      border-bottom: solid 1px #ddd;
    }
    table tbody tr:last-of-type {
      border: 0;
    }
    table td:not(:last-child) {
      padding-right: 56px;
    }
    table tbody tr:hover {
      background-color: #eee;
    }
    </style>
    <div class="body">
      <h1>
        <span class="product-name">[[data.productName]]</span>
        <span class="version">
          <template is="dom-repeat" items="[[version]]">
            <template is="dom-if" if="[[index]]">+</template>
            [[item.value]]<template is="dom-if" if="[[item.ratio]]">&nbsp;<span class="ratio">[[asPercentage(item.ratio)]]%</span></template>
          </template>
        </span>
        <span class$="state [[toCssClasses(data.state)]]">[[humanReadable(data.state)]]</span>
      </h1>
      <div class="actions">
        <template is="dom-repeat" items="[[data.actions]]">
          <paper-button disabled="[[computeDisabled(isInAction, item.authorized)]]" on-tap="onActionTap" raised>[[humanReadable(item.type)]]</paper-button>
        </template>
      </div>
      <paper-card id="general">
        <h1>General</h1>
        <p>Requested by [[data.creator]] on [[timestampToDates(data.creationDate)]]</p>
        <template is="dom-if" if="[[data.comment]]"><p><perpetuo-markdown-viewer md="[[data.comment]]"></perpetuo-markdown-viewer></p></template>
      </paper-card>
      <paper-card id="target">
        <h1>Deployment Target</h1>
        <p>[[data.target]]</p>
      </paper-card>
      <template is="dom-repeat" items="[[data.operations]]">
        <paper-card id="operations">
          <perpetuo-deployment-operation index="[[index]]" data="[[item]]" show-execution-logs="[[data.showExecutionLogs]]"></perpetuo-deployment-operation>
        </paper-card>
      </template>
    </div>

    <paper-dialog id="revertPlan" with-backdrop>
      <h2>Revert plan</h2>
      <template is="dom-if" if="[[revertPlan.determined.length]]">
        <p>The following versions will be applied:</p>
        <paper-dialog-scrollable>
          <table>
            <thead>
              <tr>
                <th>Version</th>
                <th>Targets</th>
              </tr>
            </thead>
            <tbody>
              <template is="dom-repeat" items="[[revertPlan.determined]]">
                <tr>
                  <td>
                    <template is="dom-repeat" items="[[computeVersion(item)]]">
                      <template is="dom-if" if="[[index]]">+</template>
                      [[item.value]]
                      <template is="dom-if" if="[[item.ratio]]">&nbsp;<span class="ratio">[[asPercentage(item.ratio)]]%</span></template>
                    </template>
                  </td>
                  <td>[[sumUpArray(item.targetAtoms)]]</td>
                </tr>
              </template>
            </tbody>
          </table>
        </paper-dialog-scrollable>
      </template>
      <template is="dom-if" if="[[revertPlan.undetermined.length]]">
        <p>Some impacted targets have no previous version ([[sumUpArray(revertPlan.undetermined)]]).</p>
        <p>Please specify the version to use for them:
          <paper-input label="Default version" value="{{defaultVersion}}"></paper-input>
        </p>
      </template>
      <div class="buttons">
        <paper-button dialog-dismiss class="cancel" raised>Cancel</paper-button>
        <paper-button dialog-confirm class="revert" raised>Revert</paper-button>
      </div>
    </paper-dialog>

    <perpetuo-conflicting-deployment-requests id="conflictPanel"></perpetuo-conflicting-deployment-requests>

  </template>
  <script>
  (function () {
    class PerpetuoDeploymentRequest extends Polymer.Element {
      static get is() { return 'perpetuo-deployment-request'; }

      static get properties() {
        return {
          deploymentRequestId: {type: String, observer: 'refresh'},
          active: {type: Boolean, observer: 'onActiveChanged'},
          data: Object,
          version: {type: Array, computed: 'computeVersion(data)'},
          isInAction: Boolean,
          revertPlan: Object,
          defaultVersion: String,
        }
      }

      timestampToDates(t) {
        const date = new Date(t * 1000);

        const localYMD = date.getFullYear() + '-' + (date.getMonth() + 1) + '-' + date.getDate();
        const localTime = date.toTimeString().split(' ')[0];

        const iso = date.toISOString().split('T');
        const isoYMD = iso[0].replace(/-0/g, '-');
        const isoTime = iso[1].split('.')[0];

        return `${isoYMD} at ${isoTime} UTC (` + (localYMD !== isoYMD ? localYMD + ' ' : '') + localTime + ' local time)';
      }

      constructor() {
        super();

        this.client = new Perpetuo.Client();
      }

      // TODO: factor with deployment-request-table
      onActiveChanged(active) {
        if (active) {
          const refreshDelay = 1000;
          (function installRefresh() {
            const reinstallRefresh = () => installRefresh.apply(this);
            this.refreshTimeoutId = setTimeout(() => this.refresh().then(reinstallRefresh, reinstallRefresh), refreshDelay);
          }).apply(this);
        } else {
          clearTimeout(this.refreshTimeoutId);
        }
      }

      onActionTap(e) {
        switch (e.model.item.type) {
          case 'deploy':
            return this.onDeployTap(e);
          case 'revert':
            return this.onRevertTap(e);
        }
      }

      actionLock(f) {
        if (!this.isInAction) {
          this.isInAction = true;
          const releaseLock = () => {
            this.isInAction = false;
          };
          f().then(releaseLock)
             .catch(releaseLock);
        }
      }

      onDeployTap(e) {
        this.actionLock(() =>
          this.client.deployDeploymentRequest(this.deploymentRequestId)
              .then(r => {
                if (400 <= r.status && r.status < 500)
                  return r.json()
                          .then(body => {
                            if (body.conflicts) {
                              const panel = this.$.conflictPanel;
                              panel.conflicts = body.conflicts;
                              panel.open();
                            }
                          });
                return this.refresh();
              })
        );
      }

      showRevertPlan() {
        return new Promise((resolve, reject) => {
          const panel = this.$.revertPlan;
          const onOpenedChanged = (e) => {
            if (!e.detail.value) {
              panel.removeEventListener('opened-changed', onOpenedChanged);
              if (panel.closingReason.confirmed) {
                resolve();
              } else {
                reject();
              }
            }
          };
          panel.addEventListener('opened-changed', onOpenedChanged);
          panel.open();
        });
      }

      revert() {
        return this.client.deviseRevertPlan(this.deploymentRequestId)
                   .then(r => {
                     if (r.status === 200)
                       return r.json()
                               .then(body => {
                                 this.revertPlan = body;
                                 this.defaultVersion = undefined;
                                 this.showRevertPlan().then(_ => {
                                   const body = this.defaultVersion ? {defaultVersion: this.defaultVersion} : {};
                                   this.client.revertDeploymentRequest(this.deploymentRequestId, body);
                                 });
                               });
                     return this.refresh();
                   });
      }

      onRevertTap(e) {
        this.actionLock(() =>
          this.revert()
        );
      }

      computeDisabled(isInAction, isAuthorized) {
        return isInAction || !isAuthorized;
      }

      computeVersion(data) {
        return Array.isArray(data.version) ? data.version : [{value: data.version}];
      }

      asPercentage(ratio) {
        return ratio * 100;
      }

      humanReadable(actionName) {
        return actionName.replace(/([A-Z])/g, ' $1');
      }

      toCssClasses(actionName) {
        return actionName.replace(/([A-Z])/g, '-$1').toLowerCase();
      }

      sumUpArray(arr) {
        const sorted = arr.sort();
        return (sorted.length < 8 ?
                sorted :
                sorted.slice(0, 3).concat(["..."], sorted.slice(-3))
        ).join(", ");
      }

      refresh() {
        return this.deploymentRequestId === undefined ?
               Promise.resolve(false)
          : this.client.fetchDeploymentRequest(this.deploymentRequestId).then(_ => {
            this.data = _;
          });
      }
    }

    customElements.define(PerpetuoDeploymentRequest.is, PerpetuoDeploymentRequest);
  } ());
  </script>
</dom-module>

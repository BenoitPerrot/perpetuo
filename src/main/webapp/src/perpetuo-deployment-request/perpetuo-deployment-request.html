<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">

<link rel="import" href="../perpetuo-app/perpetuo-app-drawer.html">
<link rel="import" href="../perpetuo-app/perpetuo-app-toolbar.html">
<link rel="import" href="../perpetuo-deployment-request/perpetuo-deployment-operation.html">

<dom-module id="perpetuo-deployment-request">
  <template>
    <style>
    .body {
      display: flex;
      flex-direction: column;
      padding: 20px;
    }
    .body > h1 {
      border-bottom: solid 1px #ddd;
      margin-top: 0;
      padding: 0 0 20px 0;
      font-weight: normal;
      display: flex;
      align-items: center;
    }

    .version {
      margin-left: 2em;
    }
    .ratio {
      vertical-align: super;
      font-size: smaller;
      color: gray;
    }

    .state {
      border-radius: 3px;
      margin-left: 2em;
      padding: 0.7em 0.57em;
      text-transform: uppercase;
      background-color: #f5f5f5;
    }
    .state.succeeded {
      color: #fff;
      background-color: #0f9d58;
    }
    .state.failed {
      color: #fff;
      background-color: #f44336;
    }
    .state.in-progress {
      color: #fff;
      background: repeating-linear-gradient(-45deg, #009688, #009688 10px, #26a69a 10px, #26a69a 20px);
    }

    .actions {
      margin: 0 1em 1em 0;
    }

    #general, #target, #operations {
      padding: 24px 16px;
    }

    paper-card {
      margin-bottom: 1em;
    }
    paper-card h1, paper-card h2 {
      margin: 0;
      font-weight: normal;
    }
    paper-card h1 {
      font-size: 24px;
    }

    .cancel {
      background-color: #f44336;
      color: #fff;
    }
    .rollback {
      background: #26a69a;
      color: #fff;
    }
    </style>
    <app-header-layout>
      <app-header reveals>
        <perpetuo-app-toolbar on-drawer-toggle-tap="toggleDrawer" page-title="Deployment Requests" on-login-changed="onLoginChanged"></perpetuo-app-toolbar>
      </app-header>
      <div class="body">
        <h1>
          <span class="product-name">[[data.productName]]</span>
          <span class="version">
            <template is="dom-repeat" items="[[version]]">
              <template is="dom-if" if="[[index]]">+</template>
              [[item.value]]<template is="dom-if" if="[[item.ratio]]">&nbsp;<span class="ratio">[[asPercentage(item.ratio)]]%</span></template>
            </template>
          </span>
          <span class$="state [[data.state]]">[[data.state]]</span>
        </h1>
        <div class="actions">
          <template is="dom-repeat" items="[[data.actions]]">
            <paper-button disabled="[[computeDisabled(isInAction, item.authorized)]]" on-tap="onActionTap" raised>[[humanReadable(item.type)]]</paper-button>
          </template>
        </div>
        <paper-card id="general">
          <h1>General</h1>
          <p>Requested by [[data.creator]] on [[timestampToDates(data.creationDate)]]</p>
          <template is="dom-if" if="[[comment.description]]"><p>[[comment.description]]</p></template>
          <template is="dom-if" if="[[comment.ticket]]"><p>JIRA: <a href="[[comment.ticket.url]]">[[comment.ticket.reference]]</a></p></template>
        </paper-card>
        <paper-card id="target">
          <h1>Deployment Target</h1>
          <p>[[data.target]]</p>
        </paper-card>
        <template is="dom-repeat" items="[[data.operations]]">
          <paper-card id="operations">
            <perpetuo-deployment-operation index="[[index]]" data="[[item]]" show-executions="[[showExecutions]]"></perpetuo-deployment-operation>
          </paper-card>
        </template>
      </div>
    </app-header-layout>
    <perpetuo-app-drawer id="drawer"></perpetuo-app-drawer>

    <paper-dialog id="rollbackDefaultVersionSpecifier" with-backdrop>
      <h2>More information required for rolling back</h2>
      <paper-dialog-scrollable>
        <p>Some targets impacted by this deployment request have no previous version.</p>
        <p>Please specify the version to use for them.<paper-input label="Default rollback version" value="{{rollbackDefaultVersion}}"></paper-input></p>
      </paper-dialog-scrollable>
      <div class="buttons">
        <paper-button dialog-dismiss class="cancel" raised>Cancel</paper-button>
        <paper-button dialog-confirm class="rollback" raised>Rollback</paper-button>
      </div>
    </paper-dialog>

  </template>
  <script>
  Polymer({
    is: 'perpetuo-deployment-request',

    properties: {
      deploymentRequestId: {type: String, observer: 'refresh'},
      active: {type: Boolean, observer: 'onActiveChanged'},
      data: Object,
      version: {type: Array, computed: 'computeVersion(data)'},
      comment: {type: Object, computed: 'computeComment(data)'},
      showExecutions: Boolean,
      isInAction: Boolean,
      rollbackDefaultVersion: String,
    },

    timestampToDates(t) {
      const date = new Date(t * 1000);

      const localYMD = date.getFullYear() + '-' + (date.getMonth() + 1) + '-' + date.getDate();
      const localTime = date.toTimeString().split(' ')[0];

      const iso = date.toISOString().split('T');
      const isoYMD = iso[0].replace(/-0/g, '-');
      const isoTime = iso[1].split('.')[0];

      return `${isoYMD} at ${isoTime} UTC (` + (localYMD !== isoYMD ? localYMD + ' ' : '') + localTime + ' local time)';
    },

    created() {
      this.client = new Perpetuo.Client();
    },

    // TODO: factor with deployment-request-table
    onActiveChanged(active) {
      if (active) {
        const refreshDelay = 1000;
        (function installRefresh() {
          const reinstallRefresh = () => installRefresh.apply(this);
          this.refreshTimeoutId = setTimeout(() => this.refresh().then(reinstallRefresh, reinstallRefresh), refreshDelay);
        }).apply(this);
      } else {
        clearTimeout(this.refreshTimeoutId);
      }
    },

    onActionTap(e) {
      switch (e.model.item.type) {
        case 'deploy':
          return this.onDeployTap(e);
        case 'revert':
          return this.onRevertTap(e);
      }
    },

    actionLock(f) {
      if (!this.isInAction) {
        this.isInAction = true;
        const releaseLock = () => {
          this.isInAction = false;
        };
        f().then(releaseLock)
          .catch(releaseLock);
      }
    },

    onDeployTap(e) {
      this.actionLock(() =>
        this.client.deployDeploymentRequest(this.deploymentRequestId).then(_ => this.refresh())
      );
    },

    requiresExtraInfo() {
      return new Promise((resolve, reject) => {
        const panel = this.$.rollbackDefaultVersionSpecifier;
        const onOpenedChanged = (e) => {
          if (!e.detail.value) {
            panel.removeEventListener('opened-changed', onOpenedChanged);
            if (panel.closingReason.confirmed) {
              resolve(this.rollbackDefaultVersion);
            } else {
              reject();
            }
          }
        };
        panel.addEventListener('opened-changed', onOpenedChanged);
        panel.open();
      });
    },

    revert(extraInfo) {
      return this.client.revertDeploymentRequest(this.deploymentRequestId, extraInfo)
        .then(r => {
          if (r.status === 422)
            return r.json()
              .then(body => {
                if (body.required)
                  this.requiresExtraInfo().then(extra => this.revert({[body.required]: extra}));
              });
          return this.refresh();
        })
    },

    onRevertTap(e) {
      this.actionLock(() =>
        this.revert()
      );
    },

    computeDisabled(isInAction, isAuthorized) {
      return isInAction || !isAuthorized;
    },

    computeVersion(data) {
      return Array.isArray(data.version) ? data.version : [{value: data.version}];
    },

    asPercentage(ratio) {
      return ratio * 100;
    },

    humanReadable(actionName) {
      return actionName.replace(/([A-Z])/g, ' $1');
    },

    // TODO: factor with perpetuo-deployment-request-entry, or remove it from -entry
    computeComment(data) {
      const fields = data.comment.split("ticket: ");
      let ret = {description: fields[0]};
      if (fields[1])
        ret.ticket = {url: fields[1], reference: fields[1].split("/").splice(-1)[0]};
      return ret;
    },

    toggleDrawer() {
      this.$.drawer.toggle();
    },

    // Show executions only to admins for the moment, as they only contain information relevant to Perpetuo's debug
    // TODO: move authorization to back-end <<
    onLoginChanged(e) {
      this.showExecutions = ['be.perrot', 'h.lerebours', 'r.guillard',
                             'e.peroumalnaik', 'g.bourguignon', 'm.runtz', 'm.molongo',
                             'm.nguyen', 'm.soltani', 's.guerrier', 't.zhuang',
                             'e.moutarde', 'd.michau'].includes(e.detail.value);
    },
    // >>

    refresh() {
      return this.deploymentRequestId === undefined ?
        Promise.resolve(false)
        : this.client.fetchDeploymentRequest(this.deploymentRequestId).then(_ => {
          this.data = _;
        });
    }

  })
  </script>
</dom-module>

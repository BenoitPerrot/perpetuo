<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-progress/paper-progress.html">

<link rel="import" href="../perpetuo-app/perpetuo-app-toolbar.html">
<link rel="import" href="../perpetuo-deployment-request/perpetuo-conflicting-deployment-requests.html">
<link rel="import" href="../perpetuo-deployment-request/perpetuo-deployment-operation.html">
<link rel="import" href="../perpetuo-markdown/perpetuo-markdown-viewer.html">

<dom-module id="perpetuo-deployment-request">
  <template>
    <style>
    .body {
      display: flex;
      flex-direction: column;
      padding: 20px;
    }

    .body[hidden] {
      opacity: 0;
    }
    .body:not([hidden]) {
      opacity: 1;
      transition: opacity 250ms;
    }

    .columns {
      display: flex;
      flex-direction: row;
    }
    .columns > * {
      flex: 1;
    }

    .intent > h1 {
      margin-top: 0;
      padding: 0;
      font-weight: normal;
      display: flex;
      align-items: center;
    }

    .version {
      margin-left: 2em;
    }
    .ratio {
      vertical-align: super;
      font-size: smaller;
      color: gray;
    }

    .state {
      text-transform: uppercase;
      color: #555;
      margin: auto;
      text-align: center;
      font-weight: 500;
      font-size: 32px;
    }
    .state.deployed {
      color: #0f9d58;
    }
    .state.failed, .state.flopped, .state.reverted {
      color: #f44336;
    }
    .state.in-progress {
      color: #0086b2;
    }

    .actions {
      margin: 0 1em 1em 0;
    }
    .action {
      margin-top: 1em;
    }
    .action span {
      color: #555;
    }

    #target, .operations {
      padding: 24px 16px;
    }

    .operations {
      border: solid 1px;
      border-left: solid 24px;
    }
    .operations.succeeded {
      border-color: #0f9d58;
    }
    .operations.failed, .operations.flopped {
      border-color: #f44336;
    }
    .operations.in-progress {
      border-color: #0086b2;
    }

    perpetuo-deployment-operation:not(:first-of-type) {
      margin-top: 16px;
    }

    .operations h1 {
      margin: 0;
      font-weight: normal;
    }

    paper-card {
      margin-bottom: 1em;
    }
    paper-card h1, paper-card h2 {
      margin: 0;
      font-weight: normal;
    }
    paper-card h1 {
      font-size: 24px;
    }

    .cancel {
      background-color: #f44336;
      color: #fff;
    }
    .revert {
      background: #26a69a;
      color: #fff;
    }

    #revertPlan table {
      width: 100%;
      border-collapse: collapse;
    }
    #revertPlan table th {
      font-weight: 500;
      color: #757575;
      text-align: left;
    }
    #revertPlan table td {
      color: hsl(0, 0%, 13%);
    }
    #revertPlan table tr {
      height: 42px;
      border-bottom: solid 1px #ddd;
    }
    #revertPlan table tbody tr:last-of-type {
      border: 0;
    }
    #revertPlan table td:not(:last-child) {
      padding-right: 56px;
    }
    #revertPlan table tbody tr:hover {
      background-color: #eee;
    }

    paper-progress {
      width: auto;
      --paper-progress-active-color: #0086b2;
      --paper-progress-container-color: #fff;
    }
    </style>
    <perpetuo-app-toolbar page-title="Perpetuo / Deployment Request #[[deploymentRequestId]]"></perpetuo-app-toolbar>
    <paper-progress indeterminate hidden$="[[!noData]]"></paper-progress>

    <div class="body" hidden$="[[noData]]">
      <div class="columns">
        <div class="intent">
          <h1>
            <span class="product-name">[[data.productName]]</span>
            <span class="version">
              <template is="dom-repeat" items="[[version]]">
                <template is="dom-if" if="[[index]]">+</template>
                [[item.value]]<template is="dom-if" if="[[item.ratio]]">&nbsp;<span class="ratio">[[asPercentage(item.ratio)]]%</span></template>
              </template>
            </span>
          </h1>
          <div>
            <p>Requested by [[data.creator]] on [[timestampToDates(data.creationDate)]]</p>
            <template is="dom-if" if="[[data.comment]]"><p><perpetuo-markdown-viewer md="[[data.comment]]"></perpetuo-markdown-viewer></p></template>
          </div>
        </div>
        <div>
          <div class$="state [[toCssClasses(data.state)]]">[[humanReadable(data.state)]]</div>
          <div class="actions">
            <template is="dom-repeat" items="[[data.actions]]">
              <div class="action">
                <paper-button disabled="[[computeDisabled(isInAction, item.authorized)]]" on-tap="onActionTap" raised>[[humanReadable(item.type)]]</paper-button>
                <span>[[item.comment]]</span>
              </div>
            </template>
          </div>
        </div>
      </div>
      <paper-card id="target">
        <h1>Deployment Target</h1>
        <p>[[data.target]]</p>
      </paper-card>
      <template is="dom-repeat" items="[[operationGroups]]" as="operationGroup">
        <paper-card class$="operations [[toCssClasses(operationGroup.status)]]">
          <h1>[[operationGroup.label]]</h1>
          <template is="dom-repeat" items="[[operationGroup.operations]]">
            <perpetuo-deployment-operation index="[[sub(operationGroup.operations.length, index)]]" data="[[item]]" opened="[[isOperationOpened(item.id)]]" on-opened-changed="onOperationOpenedChanged" show-execution-logs="[[data.showExecutionLogs]]"></perpetuo-deployment-operation>
          </template>
        </paper-card>
      </template>
    </div>

    <paper-dialog id="revertPlan" with-backdrop>
      <h2>Revert plan</h2>
      <template is="dom-if" if="[[revertPlan.determined.length]]">
        <p>The following versions will be applied:</p>
        <paper-dialog-scrollable>
          <table>
            <thead>
              <tr>
                <th>Version</th>
                <th>Targets</th>
              </tr>
            </thead>
            <tbody>
              <template is="dom-repeat" items="[[revertPlan.determined]]">
                <tr>
                  <td>
                    <template is="dom-repeat" items="[[computeVersion(item)]]">
                      <template is="dom-if" if="[[index]]">+</template>
                      [[item.value]]
                      <template is="dom-if" if="[[item.ratio]]">&nbsp;<span class="ratio">[[asPercentage(item.ratio)]]%</span></template>
                    </template>
                  </td>
                  <td>[[sumUpArray(item.targetAtoms)]]</td>
                </tr>
              </template>
            </tbody>
          </table>
        </paper-dialog-scrollable>
      </template>
      <template is="dom-if" if="[[revertPlan.undetermined.length]]">
        <p>Some impacted targets have no previous version ([[sumUpArray(revertPlan.undetermined)]]).</p>
        <p>Please specify the version to use for them:
          <paper-input label="Default version" value="{{defaultVersion}}"></paper-input>
        </p>
      </template>
      <div class="buttons">
        <paper-button dialog-dismiss class="cancel" raised>Cancel</paper-button>
        <paper-button dialog-confirm class="revert" raised>Revert</paper-button>
      </div>
    </paper-dialog>

    <perpetuo-conflicting-deployment-requests id="conflictPanel"></perpetuo-conflicting-deployment-requests>

  </template>
  <script>
  (function () {
    function computeOperationGroupLabel(planStepIds, plan) {
      return planStepIds
        .map(id => plan.find(_ => _.id === id))
        .map(planStep => planStep.name ? planStep.name : planStep.targetExpression)
        .join(', ');
    }

    class PerpetuoDeploymentRequest extends Polymer.Element {
      static get is() { return 'perpetuo-deployment-request'; }

      static get properties() {
        return {
          deploymentRequestId: {type: String, observer: 'onDeploymentRequestIdChanged'},
          noData: {type: Boolean, value: true},
          active: {type: Boolean, observer: 'onActiveChanged'},
          data: Object,
          operationGroups: Array,
          version: {type: Array, computed: 'computeVersion(data)'},
          isInAction: Boolean,
          revertPlan: Object,
          defaultVersion: String,
        }
      }

      timestampToDates(t) {
        const date = new Date(t * 1000);

        const localYMD = date.getFullYear() + '-' + (date.getMonth() + 1) + '-' + date.getDate();
        const localTime = date.toTimeString().split(' ')[0];

        const iso = date.toISOString().split('T');
        const isoYMD = iso[0].replace(/-0/g, '-');
        const isoTime = iso[1].split('.')[0];

        return `${isoYMD} at ${isoTime} UTC (` + (localYMD !== isoYMD ? localYMD + ' ' : '') + localTime + ' local time)';
      }

      constructor() {
        super();

        this.client = new Perpetuo.Client();
      }

      onDeploymentRequestIdChanged() {
        // TODO: have a dedicated view-model instead:
        this.noData = true;
        this.data = {
          state: '',
          creationDate: '',
          operations: []
        };
        this.operationGroups = [];
        this.operationIdToOpened = new Map(); // A Map is required to distinguish inexistence and closed-by-user
        this.refresh();
      }

      // TODO: factor with deployment-request-table
      onActiveChanged(active) {
        if (active) {
          const refreshDelay = 1000;
          (function installRefresh() {
            const reinstallRefresh = () => installRefresh.apply(this);
            this.refreshTimeoutId = setTimeout(() => this.refresh().then(reinstallRefresh, reinstallRefresh), refreshDelay);
          }).apply(this);
        } else {
          clearTimeout(this.refreshTimeoutId);
        }
      }

      onActionTap(e) {
        switch (e.model.item.type) {
          case 'deploy':
            return this.onDeployTap(e);
          case 'revert':
            return this.onRevertTap(e);
        }
      }

      actionLock(f) {
        if (!this.isInAction) {
          this.isInAction = true;
          const releaseLock = () => {
            this.isInAction = false;
          };
          f().then(releaseLock)
             .catch(releaseLock);
        }
      }

      onDeployTap(e) {
        this.actionLock(() =>
          this.client.deployDeploymentRequest(this.deploymentRequestId)
              .then(r => {
                if (400 <= r.status && r.status < 500)
                  return r.json()
                          .then(body => {
                            if (body.conflicts) {
                              const panel = this.$.conflictPanel;
                              panel.conflicts = body.conflicts;
                              panel.open();
                            }
                          });
                return this.refresh();
              })
        );
      }

      showRevertPlan() {
        return new Promise((resolve, reject) => {
          const panel = this.$.revertPlan;
          const onOpenedChanged = (e) => {
            if (!e.detail.value) {
              panel.removeEventListener('opened-changed', onOpenedChanged);
              if (panel.closingReason.confirmed) {
                resolve();
              } else {
                reject();
              }
            }
          };
          panel.addEventListener('opened-changed', onOpenedChanged);
          panel.open();
        });
      }

      revert() {
        return this.client.deviseRevertPlan(this.deploymentRequestId)
                   .then(r => {
                     if (r.status === 200)
                       return r.json()
                               .then(body => {
                                 this.revertPlan = body;
                                 this.defaultVersion = undefined;
                                 this.showRevertPlan().then(_ => {
                                   const body = this.defaultVersion ? {defaultVersion: this.defaultVersion} : {};
                                   this.client.revertDeploymentRequest(this.deploymentRequestId, body);
                                 });
                               });
                     return this.refresh();
                   });
      }

      onRevertTap(e) {
        this.actionLock(() =>
          this.revert()
        );
      }

      computeDisabled(isInAction, isAuthorized) {
        return isInAction || !isAuthorized;
      }

      computeVersion(data) {
        return Array.isArray(data.version) ? data.version : [{value: data.version}];
      }

      asPercentage(ratio) {
        return ratio * 100;
      }

      humanReadable(actionName) {
        return actionName.replace(/([A-Z])/g, ' $1');
      }

      toCssClasses(actionName) {
        return actionName.replace(/([A-Z])/g, '-$1').toLowerCase();
      }

      sumUpArray(arr) {
        const sorted = arr.sort();
        return (sorted.length < 8 ?
                sorted :
                sorted.slice(0, 3).concat(["..."], sorted.slice(-3))
        ).join(", ");
      }

      refresh() {
        return this.deploymentRequestId === undefined ?
               Promise.resolve(false)
          : this.client.fetchDeploymentRequest(this.deploymentRequestId).then(data => {
            if (data.id == this.deploymentRequestId) { // Support out-of-order responses
              this.data = data;
              const maxOperationId = this.data.operations.reduce((max, op) => max < op.id ? op.id : max, -1);
              if (!this.operationIdToOpened.has(maxOperationId)) {
                this.operationIdToOpened.set(maxOperationId, true);
              }

              this.operationGroups =
                data.operations.reduce((operationGroups, op) => {
                  let lastOperationGroup = 0 < operationGroups.length ? operationGroups[operationGroups.length - 1] : null;
                  if (!lastOperationGroup ||
                      !(op.kind === lastOperationGroup[0].kind &&
                        op.planStepIds.length === lastOperationGroup[0].planStepIds.length && op.planStepIds.every(id => lastOperationGroup[0].planStepIds.includes(id)))) {
                    lastOperationGroup = [];
                    operationGroups.push(lastOperationGroup);
                  }
                  lastOperationGroup.push(op);
                  return operationGroups;
                }, [])
                 .map(operations => ({
                   operations: operations,
                   status: operations[0].status,
                   label: computeOperationGroupLabel(operations[0].planStepIds, data.plan)
                 }));

              this.noData = false;
            }
          });
      }

      isOperationOpened(id) {
        return this.operationIdToOpened.get(id);
      }
      onOperationOpenedChanged(e) {
        this.operationIdToOpened.set(e.model.item.id, e.detail.value);
      }

      isEmpty(a) {
        return a.length === 0;
      }

      sub(a, b) {
        return a - b;
      }
    }

    customElements.define(PerpetuoDeploymentRequest.is, PerpetuoDeploymentRequest);
  } ());
  </script>
</dom-module>

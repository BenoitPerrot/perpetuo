<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">

<link rel="import" href="../perpetuo-app/perpetuo-app-drawer.html">
<link rel="import" href="../perpetuo-app/perpetuo-app-toolbar.html">
<link rel="import" href="../perpetuo-client/perpetuo-client.html">
<link rel="import" href="../perpetuo-deployment-request/perpetuo-deployment-request.html">
<link rel="import" href="../perpetuo-deployment-request/perpetuo-deployment-request-table.html">
<link rel="import" href="../perpetuo-deployment-request/perpetuo-deployment-request-creation-form.html">

<dom-module id="perpetuo-deployment-requests-page">
  <style>
  :host {
    padding: 0 24px;
  }
  app-route {
    display: none;
  }
  #pageSelector {
    flex: 1;
  }

  perpetuo-list-editor {
    display: flex;
    flex-direction: column;
  }
  </style>
  <template>
    <perpetuo-identity id="identity" login="{{login}}"></perpetuo-identity>

    <app-header-layout>
      <app-header reveals>
        <perpetuo-app-toolbar on-drawer-toggle-tap="toggleDrawer" page-title="Deployment Requests"></perpetuo-app-toolbar>
      </app-header>
      <iron-pages id="pageSelector" selected="[[selectPage(route)]]" fallback-selection="single" attr-for-selected="id">
        <div id="all">
          <paper-fab icon="add" style="position:fixed; left: 20px; top: 100px; z-index:103; background: #ff8f1c;" on-tap="onCreateTap"></paper-fab>
          <perpetuo-deployment-request-table style="margin-left: 40px;"></perpetuo-deployment-request-table>
        </div>
        <div id="single">
          <perpetuo-deployment-request></perpetuo-deployment-request>
        </div>
      </iron-pages>
    </app-header-layout>
    <perpetuo-app-drawer id="drawer"></perpetuo-app-drawer>
    <perpetuo-deployment-request-creation-form with-backdrop></perpetuo-deployment-request-creation-form>
  </template>
  <script>
  Polymer({
    is: 'perpetuo-deployment-requests-page',

    properties: {
      login: String,

      selected: { type: Number, value: 0 },

      route: { type: Object }
    },

    selectPage(route) {
      if (route.path) {
        const m = route.path.match(new RegExp('/(\\d+)'))
        if (m) {
          this.client.fetchDeploymentRequest(m[1]).then(_ => this.$$('#single perpetuo-deployment-request').data = _);
          return 'single';
        }
      }
      return 'all';
    },

    created() {
      this.client = new Perpetuo.Client();
    },

    onCreateTap() {
      if (this.login) {
        this.$$('perpetuo-deployment-request-creation-form').open();
      } else {
        this.$.identity.request();
      }
    },

    toggleDrawer() {
      this.$.drawer.toggle();
    }
  });
  </script>
</dom-module>

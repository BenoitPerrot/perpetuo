<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="../perpetuo-deployment-request/perpetuo-deployment-request-entry.html">
<link rel="import" href="../perpetuo-list-editor/perpetuo-list-editor.html">
<link rel="import" href="../perpetuo-up-down-none/perpetuo-up-down-none.html">

<dom-module id="perpetuo-deployment-request-table">
  <style>
  :host {
    display: flex;
    flex-direction: column;
  }

  .table {
    flex: 1;
    padding: 1em;
  }
  .row.heading {
    flex: 1;
    display: flex;
    align-items: center;
    padding: 0.5em 0;
    border-bottom: solid 1px #ddd;
    margin-bottom: 1em;
  }
  .product-name {
    width: 30%;
  }
  .version {
    width: 10%;
  }
  .target {
    width: 20%;
  }
  .creator {
    width: 10%;
  }
  .creation-date {
    width: 20%;
    text-align: center;
  }
  div.state {
    width: 10%;
    display: flex;
    justify-content: flex-end;
  }
  </style>
  <template>
    <perpetuo-list-editor key="productName" label="Filter by product" choices="[[products]]" on-chosen-changed="updateFilter"></perpetuo-list-editor>
    <div class="table">
      <div class="row heading">
        <perpetuo-up-down-none class="product-name" key="productName" label="Product" on-state-changed="updateOrder"></perpetuo-up-down-none>
        <perpetuo-up-down-none inverted class="version" key="version" label="Version" on-state-changed="updateOrder"></perpetuo-up-down-none>
        <span class="target">Target</span>
        <span class="creator">Creator</span>
        <perpetuo-up-down-none inverted class="creation-date" key="creationDate" label="Creation Date" on-state-changed="updateOrder"></perpetuo-up-down-none>
        <div class="state">
          <span>State</span>
        </div>
      </div>
      <template is="dom-repeat" items="[[data]]">
        <perpetuo-deployment-request-entry data="[[item]]"></perpetuo-deployment-request-entry>
      </template>
    </div>
    <div>
      <paper-icon-button icon="first-page" on-tap="onFirstPageTap" disabled="[[!hasPreviousPage]]"></paper-icon-button>
      <paper-icon-button icon="chevron-left" on-tap="onPreviousPageTap" disabled="[[!hasPreviousPage]]"></paper-icon-button>
      <span>[[page]]</span>
      <paper-icon-button icon="chevron-right" on-tap="onNextPageTap" disabled="[[!hasNextPage]]"></paper-icon-button>
    </div>
  </template>
  <script>
  Polymer({
    is: 'perpetuo-deployment-request-table',

    properties: {
      data: { type: Array, value: () => [] },
      indices: { type: Object, value: () => new Object() },
      products: { type: Array, value: () => [] },

      page: { type: Number, value: 1, observer: 'onPageChanged', notify: true },
      hasPreviousPage: { type: Boolean, computed: 'computeHasPreviousPage(page)' },
      hasNextPage: Boolean,
    },

    created() {
      this.order = [];
    },
    attached() {
      this.$$('[key=creationDate]').state = -1;
      this.productsListener = products => {
        this.products = products
      };
      this.ownerDocument.client.addProductsListener(this.productsListener);
    },
    detached() {
      this.ownerDocument.client.removeProductsListener(this.productsListener);
    },

    updateFilter(e) {
      const fieldName = e.target.getAttribute('key');
      this.ownerDocument.client.deploymentRequestFilters = e.target.chosen.map(v => {
        return {'field': fieldName, 'equals': v}
      });
    },

    updateOrder(e) {
      const toggle = e.target;
      if (toggle.state === 0) {
        this.order.splice(toggle.i - 1, 1);
        toggle.i = null;
      } else if (toggle.i === null) {
        this.order.push(toggle);
      }

      this.order.forEach((element, i) => {
        element.i = i + 1;
      });

      this.ownerDocument.client.deploymentRequestOrder = this.order.map(_ => { return { field: _.getAttribute('key'), desc: _.state < 0 } });
    },

    computeHasPreviousPage(page) {
      return 1 < page;
    },

    onFirstPageTap() {
      this.page = 1;
    },

    onPreviousPageTap() {
      if (this.hasPreviousPage) {
        --this.page;
      }
    },

    onNextPageTap() {
      if (this.hasNextPage) {
        ++this.page;
      }
    },

    onPageChanged() {
      this.hasNextPage = false; // Assume no more page
    }
  });
  </script>
</dom-module>

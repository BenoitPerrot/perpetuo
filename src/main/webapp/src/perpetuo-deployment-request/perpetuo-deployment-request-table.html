<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">

<link rel="import" href="../perpetuo-client/perpetuo-client.html">
<link rel="import" href="../perpetuo-deployment-request/perpetuo-deployment-request-creation-form.html">
<link rel="import" href="../perpetuo-deployment-request/perpetuo-deployment-request-entry.html">
<link rel="import" href="../perpetuo-list-editor/perpetuo-list-editor.html">
<link rel="import" href="../perpetuo-up-down-none/perpetuo-up-down-none.html">

<dom-module id="perpetuo-deployment-request-table">
  <template>
    <style>
    :host {
      display: flex;
      flex-direction: column;
    }

    .table {
      flex: 1;
      padding: 1em 40px;
      margin-left: 50px;
    }
    .row.heading {
      flex: 1;
      display: flex;
      align-items: center;
      padding: 0.5em 0;
      border-bottom: solid 1px #ddd;
      color: #757575;
    }
    .row.heading perpetuo-up-down-none {
      font-weight: 500;
    }
    .row.heading perpetuo-up-down-none:not([state=none]) {
      color: #212121;
    }
    .row.heading span {
      font-weight: 500;
    }
    .product-name {
      width: 40%;
    }
    .version {
      width: 10%;
    }
    .target {
      width: 20%;
    }
    .creation-date {
      width: 20%;
    }
    div.state {
      width: 10%;
      display: flex;
      justify-content: flex-end;
    }
    </style>
    <perpetuo-identity id="identity" login="{{login}}"></perpetuo-identity>

    <div sticky class="table" style="background: #fff">
      <div class="row heading">
        <perpetuo-up-down-none class="product-name" key="productName" label="Product" on-state-changed="updateOrder"></perpetuo-up-down-none>
        <span class="version">Version</span>
        <span class="target">Target</span>
        <perpetuo-up-down-none inverted class="creation-date" key="creationDate" label="Creation Date" state="down" on-state-changed="updateOrder"></perpetuo-up-down-none>
        <div class="state">
          <span>State</span>
        </div>
      </div>
      <div style="display: flex;">
        <div class="product-name">
          <perpetuo-list-editor key="productName" label="Filter" choices="[[productNames]]" initial-count="10" on-selected-items-changed="updateFilter"></perpetuo-list-editor>
        </div>
        <div class="version"></div>
        <span class="target"></span>
        <div class="creation-date">
          <paper-dropdown-menu label="Time Zone">
            <paper-listbox slot="dropdown-content" selected="0" selected-item="{{timeZoneItem}}">
              <paper-item timestamp-converter="timestampToUTCDate">UTC +0</paper-item>
              <paper-item timestamp-converter="timestampToLocalDate">Local</paper-item>
            </paper-listbox>
          </paper-dropdown-menu>
        </div>
        <div class="state"></div>
      </div>
    </div>
    <paper-fab icon="add" style="position:fixed; left: 20px; top: 105px; background: #ff8f1c;" on-tap="onCreateTap"></paper-fab>
    <div class="table">
      <template is="dom-repeat" items="[[data]]">
        <perpetuo-deployment-request-entry data="[[item]]" expanded="[[isEntryExpanded(item.id)]]" on-expanded-changed="onEntryExpandedChanged"></perpetuo-deployment-request-entry>
      </template>
    </div>
    <div>
      <paper-icon-button icon="first-page" on-tap="onFirstPageTap" disabled="[[!hasPreviousPage]]"></paper-icon-button>
      <paper-icon-button icon="chevron-left" on-tap="onPreviousPageTap" disabled="[[!hasPreviousPage]]"></paper-icon-button>
      <span>[[page]]</span>
      <paper-icon-button icon="chevron-right" on-tap="onNextPageTap" disabled="[[!hasNextPage]]"></paper-icon-button>
    </div>

    <perpetuo-deployment-request-creation-form></perpetuo-deployment-request-creation-form>

  </template>
  <script>
  Polymer({
    is: 'perpetuo-deployment-request-table',

    properties: {
      login: String,
      active: {type: Boolean, observer: 'onActiveChanged'},
      data: {type: Array, observer: 'convertTimestamp' },
      indices: {type: Object, value: () => new Object()},

      productNames: {type: Array, value: () => []},
      timeZoneItem: Object,
      timestampConverter: { type: String, computed: 'computeTimestampConverter(timeZoneItem)', observer: 'convertTimestamp' },

      page: {type: Number, value: 1, observer: 'onPageChanged', notify: true},
      hasPreviousPage: {type: Boolean, computed: 'computeHasPreviousPage(page)'},
      hasNextPage: Boolean,
    },

    computeTimestampConverter(timeZoneItem) {
      return timeZoneItem ? timeZoneItem.getAttribute('timestamp-converter') : null;
    },

    created() {
      this.client = new Perpetuo.Client();
      this.order = [];
      this.expandedDeploymentRequests = new Set();
      this.deploymentRequestFilters = [];
      this.deploymentRequestOrder = [];
      this.deploymentRequestOffset = 0;
      this.deploymentRequestLimit = 20;
    },

    attached() {
      this.client.fetchProducts().then(products => { this.productNames = products.map(_ => _.name); });
    },

    onActiveChanged(active) {
      if (active) {
        const refreshDelay = 1000;
        (function installRefresh() {
          const reinstallRefresh = () => installRefresh.apply(this);
          this.refreshTimeoutId = setTimeout(() => this.refresh().then(reinstallRefresh, reinstallRefresh), refreshDelay);
        }).apply(this);
      } else {
        clearTimeout(this.refreshTimeoutId);
      }
    },

    refresh(forced) {
      return this.client.fetchDeploymentRequests({
        where: this.deploymentRequestFilters,
        orderBy: this.deploymentRequestOrder,
        offset: this.deploymentRequestOffset,
        limit: this.deploymentRequestLimit
      }).then(deploymentRequests => {
        this.data = deploymentRequests;
        this.hasNextPage = this.client.hasMoreDeploymentRequests;
        if (forced) {
          this.page = 1;
        }
      });
    },

    isEntryExpanded(id) {
      return this.expandedDeploymentRequests.has(id);
    },

    onEntryExpandedChanged(e) {
      if (e.detail.value) {
        this.expandedDeploymentRequests.add(e.target.data.id);
      } else {
        this.expandedDeploymentRequests.delete(e.target.data.id);
      }
    },

    convertTimestamp() {
      if (this.data && this.timestampConverter) {
        const f = this.get(this.timestampConverter);
        this.data.forEach(obj => obj.dateString = f(obj.creationDate));
      }
    },

    timestampToUTCDate(unixTimestamp) {
      return new Date(unixTimestamp * 1000).toISOString().replace('T', ' ').replace(/-0/g, '-').split('.')[0];
    },

    timestampToLocalDate(unixTimestamp) {
      const date = new Date(unixTimestamp * 1000);
      const time = date.toTimeString().split(' ')[0];
      return date.getFullYear() + '-' + (date.getMonth() + 1) + '-' + date.getDate() + ' ' + time;
    },

    updateFilter(e) {
      const fieldName = e.target.getAttribute('key');
      this.deploymentRequestFilters = e.target.selectedItems.map(v => {
        return {'field': fieldName, 'equals': v};
      });
      this.refresh(true);
    },

    updateOrder(e) {
      const toggle = e.target;
      if (toggle.state === 'none') {
        this.order.splice(toggle.i - 1, 1);
        toggle.i = null;
      } else if (toggle.i === null) {
        this.order.push(toggle);
      }

      this.order.forEach((element, i) => {
        element.i = i + 1;
      });

      this.deploymentRequestOrder = this.order.map(_ => {
        return {field: _.getAttribute('key'), desc: _.state === 'down'};
      });
      this.refresh(true);
    },

    computeHasPreviousPage(page) {
      return 1 < page;
    },

    onFirstPageTap() {
      this.page = 1;
    },

    onPreviousPageTap() {
      if (this.hasPreviousPage) {
        --this.page;
      }
    },

    onNextPageTap() {
      if (this.hasNextPage) {
        ++this.page;
      }
    },

    onPageChanged() {
      this.hasNextPage = false; // Assume no more page
      this.deploymentRequestOffset = (this.page - 1) * this.deploymentRequestLimit;
      this.refresh();
    },

    onCreateTap() {
      if (this.login) {
        const creationForm = this.$$('perpetuo-deployment-request-creation-form');
        this.client.fetchProducts().then(products => { creationForm.products = products; });
        creationForm.open();
      } else {
        this.$.identity.request();
      }
    },
  });
  </script>
</dom-module>

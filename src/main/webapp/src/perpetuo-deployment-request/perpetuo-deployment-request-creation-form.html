<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">

<link rel="import" href="../perpetuo-deployment-request/perpetuo-deployment-request-comment-editor.html">
<link rel="import" href="../perpetuo-deployment-request/perpetuo-deployment-request-creation-error.html">
<link rel="import" href="../perpetuo-deployment-request/perpetuo-deployment-request-creator.html">
<link rel="import" href="../perpetuo-deployment-request/perpetuo-deployment-request-product-selector.html">
<link rel="import" href="../perpetuo-deployment-request/perpetuo-deployment-request-target-selector.html">
<link rel="import" href="../perpetuo-deployment-request/perpetuo-deployment-request-version-selector.html">
<link rel="import" href="../perpetuo-stepper/perpetuo-step.html">
<link rel="import" href="../perpetuo-stepper/perpetuo-stepper.html">

<dom-module id="perpetuo-deployment-request-creation-form">
  <template>
    <style>
    :host {
      display: block;
      top: 0;
    }

    #dialog {
      top: 0;
      display: flex;
      flex-direction: column;
      width: 75%;
      max-width: 1000px;
    }

    paper-button:not([disabled]).blue {
      background: #0086b2;
      color: #fff;
    }
    paper-button:not([disabled]).white {
      background-color: #fff;
      color: hsl(0,0%,40%);
    }

    h1 {
      margin: 0;
      padding-top: 24px;
      min-height: 40px;
      background-color: #0086b2;
      color: #fff;
      font-size: 22px;
      font-weight: 100;
    }
    </style>
    <paper-dialog id="dialog" with-backdrop on-opened-changed="clear">
      <h1>New Deployment Request</h1>
      <paper-dialog-scrollable>
    <perpetuo-stepper id="stepper" on-stepper-cancelled="onStepperCancelled" on-stepper-completed="onStepperCompleted">

      <perpetuo-step id="productSelectionStep" label="Select Product" complete-label="Continue" no-cancel-button
                     on-step-enter="onProductSelectionStepEnter" on-step-leave="onProductSelectionStepLeave"
                     complete-disabled="[[!selectedProductName]]">
        <perpetuo-deployment-request-product-selector slot="content" id="productSelector"
                                                      products="[[products]]" selected-product-name="{{selectedProductName}}"></perpetuo-deployment-request-product-selector>
      </perpetuo-step>

      <perpetuo-step id="versionSelectionStep" label="Select Version" complete-label="Continue" cancel-label="Back"
                     on-step-enter="onVersionSelectionStepEnter" on-step-leave="onVersionSelectionStepLeave">
        <perpetuo-deployment-request-version-selector slot="content" id="versionSelector"
                                                      product-name="[[selectedProductName]]" selected-version="{{selectedVersion}}"></perpetuo-deployment-request-version-selector>
      </perpetuo-step>

      <perpetuo-step label="Specify Target" complete-label="Continue" cancel-label="Back">
        <perpetuo-deployment-request-target-selector slot="content" product-name="[[selectedProductName]]" id="targetSelector"></perpetuo-deployment-request-target-selector>
      </perpetuo-step>

      <perpetuo-step label="Comment"
                     cancel-label="Back" active="{{commentStepActive}}"
                     on-step-enter="onCommentStepEnter" on-step-leave="onCommentStepLeave" no-complete-button>
        <perpetuo-deployment-request-comment-editor slot="content" id="commentEditor"></perpetuo-deployment-request-comment-editor>
      </perpetuo-step>

    </perpetuo-stepper>
      </paper-dialog-scrollable>

      <div class="buttons">
        <paper-button id="create" class="blue" on-tap="create" disabled>Create</paper-button>
        <paper-button id="cancel" class="white" dialog-dismiss>Cancel</paper-button>
      </div>
    </paper-dialog>

    <perpetuo-deployment-request-creation-error id="errorDialog"></perpetuo-deployment-request-creation-error>
  </template>
  <script>
  (function () {
    class PerpetuoDeploymentRequestCreationForm extends Polymer.Element {
      static get is() { return 'perpetuo-deployment-request-creation-form'; }

      static get properties() {
        return {
          products: { type: Array, value: () => [] },
          selectedProductName: { type: String, observer: 'onSelectedProductNameChanged'},
          selectedVersion: String
        };
      }

      onProductSelectionStepEnter(e) {
        this.$.productSelector.disabled = false;
      }

      onProductSelectionStepLeave(e) {
        this.$.productSelector.disabled = true;
      }

      onVersionSelectionStepEnter(e) {
        this.$.versionSelector.disabled = false;
      }

      onVersionSelectionStepLeave(e) {
        this.$.versionSelector.disabled = true;
      }

      onCommentStepEnter(e) {
        this.$.create.disabled = false;
      }

      onCommentStepLeave(e) {
        this.$.create.disabled = true;
      }

      onSelectedProductNameChanged(name) {
        this.$.versionSelector.clear();
        if (name) {
          this.$.productSelectionStep.fireStepCompleted();
        }
      }

      constructor() {
        super();
      }

      onStepperCancelled() {
        this.$.dialog.close();
      }

      onStepperCompleted() {
        this.create();
      }

      open() {
        this.$.dialog.open();
      }

      close() {
        this.$.dialog.close();
      }

      create() {
        this.$.create.disabled = true;
        new Perpetuo.DeploymentRequestCreator()
                    .create(this.selectedProductName,
                            this.selectedVersion,
                            [{name: '', target: this.$.targetSelector.value}],
                            this.$.commentEditor.value)
                    .then(r => {
                      if (r.ok) {
                        r.json().then(o => {
                          window.location.replace(`/deployment-requests/${o.id}`);
                        });
                        this.close();
                      } else {
                        r.json().then(o => {
                          this.$.errorDialog.errors = o.errors;
                          this.$.errorDialog.open();
                        });
                      }
                    })
      }

      clear() {
        this.$.stepper.reset();
        this.$.productSelector.clear();
        this.$.versionSelector.disabled = true;
        this.$.versionSelector.clear();
        this.$.targetSelector.clear();
        this.$.commentEditor.clear();
        this.$.create.disabled = true;
      }
    }

    customElements.define(PerpetuoDeploymentRequestCreationForm.is, PerpetuoDeploymentRequestCreationForm);
  } ());
  </script>
</dom-module>

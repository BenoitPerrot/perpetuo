<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-dialog-behavior/paper-dialog-behavior.html">
<link rel="import" href="../../bower_components/paper-dialog-behavior/paper-dialog-shared-styles.html">
<link rel="import" href="../../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">

<link rel="import" href="../perpetuo-deployment-request/perpetuo-criteo-target-expression-editor.html">
<link rel="import" href="../perpetuo-client/perpetuo-client.html">

<dom-module id="perpetuo-input-suggester">
  <template>
    <style>
    :host {
      --paper-item-selected-weight: normal;
    }
    </style>
    <paper-input id="selector" label="Version" value="{{selection}}" on-focus="onFocus" on-focusout="onFocusOut"></paper-input>

    <div id="suggester"
         style="z-index: 103; position: absolute; overflow: auto; background:#fff; box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);"
         hidden>
      <paper-listbox on-focusout="onFocusOut">
        <template is="dom-repeat" items="[[highlight(suggestions, selection)]]">
          <paper-item style="cursor:pointer" on-tap="selectSuggestion" on-focusout="onFocusOut"><span style="font-weight: bold">[[item.high]]</span><span>[[item.low]]</span></paper-item>
        </template>
      </paper-listbox>
    </div>
  </template>
  <script>
  Polymer({
    is: 'perpetuo-input-suggester',

    properties: {
      selection: { type: String, notify: true },
      suggestions: { type: Array, value: () => [] }
    },

    onFocus(e) {
      this.$.suggester.hidden = false;
    },

    onFocusOut(e) {
      if (e.relatedTarget) {
        let parent = e.relatedTarget.parentElement;
        while (parent && parent !== this) {
          parent = parent.parentElement;
        }
        if (parent !== this) {
          this.$.suggester.hidden = true;
        }
      } else {
        this.$.suggester.hidden = true;
      }
    },

    selectSuggestion(e) {
      this.selection = e.model.item.full;
    },

    highlight(suggestions, selection) {
      const x = suggestions.map(_ =>
        _.startsWith(selection) ? { high: selection, low: _.substring(selection.length), full: _ } : null
      ).filter(_ => _ !== null);
      return x;
    },
  })
  </script>
</dom-module>

<dom-module id="perpetuo-deployment-request-creation-form">
  <template>
    <style>
    :host {
      display: block;
      top: 0;
      border-radius: 2px;
    }

    .product-name-version {
      display: flex;
      flex-direction: row;
      justify-content: space-between;
    }
    .product-name-version > * {
      width: 45%;
    }

    :host .versionMessage {
      margin: 0;
      color: red;
    }
    :host([is-version-valid]) .versionMessage {
      visibility: hidden;
    }

    .create {
      background: #26a69a;
      color: #fff;
    }
    .cancel {
      background-color: #f44336;
      color: #fff;
    }
    </style>
    <style include="paper-dialog-shared-styles"></style>
    <h2>New Deployment Request</h2>
    <paper-dialog-scrollable>
      <div class="product-name-version">
        <paper-dropdown-menu label="Product" no-animations>
          <paper-listbox id="productSelector" class="dropdown-content" selected-item="{{selectedProductItem}}">
            <template is="dom-repeat" items="[[products]]">
              <paper-item name="[[item.name]]">[[item.name]]</paper-item>
            </template>
          </paper-listbox>
        </paper-dropdown-menu>
        <div>
          <perpetuo-input-suggester suggestions="[[versionSuggestions]]" selection="{{selectedVersion}}"></perpetuo-input-suggester>
          <p class="versionMessage">Requested version could not be validated</p>
          <p class="versionMessage">[[reason]]</p>
        </div>
      </div>
      <!-- TODO: Make this a _pluggable_ component -->
      <perpetuo-criteo-target-expression-editor product-name="[[selectedProductName]]" id="targetSelector"></perpetuo-criteo-target-expression-editor>
      <paper-input id="lastValidatedVersion" label="Last Validated Version"></paper-input>
      <paper-textarea id="commentEditor" label="Comment"></paper-textarea>
    </paper-dialog-scrollable>
    <div class="buttons">
      <paper-button dialog-dismiss class="cancel" raised>Cancel</paper-button>
      <paper-button dialog-confirm class="create" raised on-tap="create">Create</paper-button>
    </div>
  </template>
  <script>
  Polymer({
    is: 'perpetuo-deployment-request-creation-form',

    properties: {
      isVersionValid: { type: Boolean, reflectToAttribute: true, value: true },
      reason: { type: String },
      selectedProductItem: Object,
      selectedProductName: { type: String, computed: 'computeSelectedProductName(selectedProductItem)', observer: 'onSelectedProductNameChanged' },
      products: { type: Array, value: () => [] },
      versionSuggestions: { type: Array, value: () => [] },
      selectedVersion: { type: String, notify: true, observer: 'onSelectedVersionChanged' }
    },

    behaviors: [
      Polymer.PaperDialogBehavior
    ],

    onSelectedVersionChanged(v) {
      if (v && this.selectedProductName) {
        this.client.validateProductVersion(this.selectedProductName, v).then(r => {
          if (v === this.selectedVersion) { // Support out-of-order execution
            this.isVersionValid = r.valid;
            if (!r.valid) {
              this.reason = r.reason;
            }
          }
        });
      } else {
        this.isVersionValid = true;
      }
    },

    computeSelectedProductName(selectedProductItem) {
      return selectedProductItem ? selectedProductItem.name : null;
    },

    onSelectedProductNameChanged(name) {
      this.versionSuggestions = [];
      if (name !== null) {
        this.client.suggestProductVersions(name).then(_ => {
          if (!_.errors) { // TODO: decide of error handling in the client
            if (this.selectedProductName === name) { // Support out-of-order responses
              this.versionSuggestions = _;
            }
          }
        });
      }
    },

    attached() {
      this.client = new Perpetuo.Client();
      this.addEventListener('opened-changed', () => { this.clear() });
    },

    create() {
      const comment =
        (this.$.commentEditor.value || '') +
        (this.$.lastValidatedVersion.value ? `${this.$.commentEditor.value ? '\n' : ''}Last validated version: ${this.$.lastValidatedVersion.value}` : '')
      this.client.createDeploymentRequest(this.selectedProductName,
                                          // TODO: remove this hack as soon as the UI allows inputing complex version specifications <<
                                          (_ => { try { const x = JSON.parse(_); return Array.isArray(x) ? x : _; } catch (e) { return _; } }) (this.selectedVersion),
                                          // >>
                                          this.$.targetSelector.value,
                                          comment)
          .then(r => {
            if (r.ok) {
              r.json().then(o => window.location.replace(o.ticketUrl));
            }
            this.close();
          })
    },

    clear() {
      this.$.productSelector.selected = null;
      this.selectedVersion = '';
      this.$.lastValidatedVersion.value = '';
      this.$.targetSelector.value = '';
      this.$.commentEditor.value = '';
    },
  });
  </script>
</dom-module>

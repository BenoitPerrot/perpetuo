<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">

<link rel="import" href="../perpetuo-client/perpetuo-client.html">
<link rel="import" href="../perpetuo-deployment-request/perpetuo-deployment-request-creation-error.html">

<dom-module id="perpetuo-deployment-request-creation-form">
  <template>
    <style>
    :host {
      display: block;
      top: 0;
      border-radius: 2px;
    }

    .product-name-version {
      display: flex;
      flex-direction: row;
      justify-content: space-between;
    }
    .product-name-version > * {
      width: 45%;
    }

    :host .versionMessage {
      margin: 0;
      color: red;
    }
    :host([is-version-valid]) .versionMessage {
      visibility: hidden;
    }

    .create {
      background: #26a69a;
      color: #fff;
    }
    .cancel {
      background-color: #f44336;
      color: #fff;
    }

    #dialog {
      top: 0;
    }
    </style>
    <paper-dialog id="dialog" with-backdrop>
      <h2>New Deployment Request</h2>
      <paper-dialog-scrollable>
        <div class="product-name-version">
          <paper-dropdown-menu label="Product" no-animations>
            <paper-listbox id="productSelector" slot="dropdown-content" selected-item="{{selectedProductItem}}">
              <template is="dom-repeat" items="[[products]]">
                <paper-item name="[[item.name]]">[[item.name]]</paper-item>
              </template>
            </paper-listbox>
          </paper-dropdown-menu>
          <paper-input id="versionEditor" label="Version"></paper-input>
        </div>
        <paper-input id="targetEditor" label="Target"></paper-input>
        <paper-textarea id="commentEditor" label="Comment"></paper-textarea>
      </paper-dialog-scrollable>
      <div class="buttons">
        <paper-button dialog-dismiss class="cancel" raised>Cancel</paper-button>
        <paper-button class="create" raised on-tap="create">Create</paper-button>
      </div>
    </paper-dialog>

    <perpetuo-deployment-request-creation-error id="errorDialog"></perpetuo-deployment-request-creation-error>
  </template>
  <script>
  (function () {
    class PerpetuoDeploymentRequestCreationForm extends Polymer.Element {
      static get is() { return 'perpetuo-deployment-request-creation-form'; }

      static get properties() {
        return {
          selectedProductItem: Object,
          selectedProductName: { type: String, computed: 'computeSelectedProductName(selectedProductItem)' },
          products: { type: Array, value: () => [] },
        };
      }

      computeSelectedProductName(selectedProductItem) {
        return selectedProductItem ? selectedProductItem.name : null;
      }

      constructor() {
        super();

        this.client = new Perpetuo.Client();
      }

      connectedCallback() {
        super.connectedCallback();

        this.$.dialog.addEventListener('opened-changed', () => { this.clear() });
      }

      open() {
        this.$.dialog.open();
      }

      close() {
        this.$.dialog.close();
      }

      create() {
        const comment = this.$.commentEditor.value || '';
        this.client.createDeploymentRequest(this.selectedProductName,
                                            // TODO: remove this hack as soon as the UI allows inputing complex version specifications <<
                                            (_ => { try { const x = JSON.parse(_); return Array.isArray(x) ? x : _; } catch (e) { return _; } }) (this.$.versionEditor.value),
                                            // >>
                                            this.$.targetEditor.value,
                                            comment)
            .then(r => {
              if (r.ok) {
                r.json().then(o => {
                  window.location.replace(`/deployment-requests/${o.id}`);
                });
                this.close();
              } else {
                r.json().then(o => {
                  this.$.errorDialog.errors = o.errors;
                  this.$.errorDialog.open();
                });
              }
            })
      }

      clear() {
        this.$.productSelector.selected = null;
        this.$.versionEditor.value = '';
        this.$.targetEditor.value = '';
        this.$.commentEditor.value = '';
      }
    }

    customElements.define(PerpetuoDeploymentRequestCreationForm.is, PerpetuoDeploymentRequestCreationForm);
  } ());
  </script>
</dom-module>

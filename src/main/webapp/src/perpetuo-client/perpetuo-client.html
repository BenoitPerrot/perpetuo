<link rel="import" href="../../bower_components/polymer/polymer.html"/>

<script>
'use strict';

this.Perpetuo = this.Perpetuo || {}
this.Perpetuo.Client = this.Perpetuo.Client || (function () {

  function jsonFetch(url, options) {
    return fetch(url, Object.assign({
      headers: { 'Accept': 'application/json', 'Content-Type': 'application/json' },
      credentials: 'include'
    }, options || {}));
  }

  function memoize(f) {
    const memoized = () => {
      if (!memoized.hasOwnProperty('__cache')) {
        memoized.__cache = f();
      }
      return memoized.__cache;
    };
    return memoized;
  }

  const fetchAuthorizeURL = memoize(() => jsonFetch('/api/auth/authorize-url').then(_ => _.json()).then(_ => _.url));

  return class Client {
    constructor(host) {
      this.host = host;
    }

    redirectToAuthorizeURL(win) {
      fetchAuthorizeURL().then(url => {
        win.location.replace(`${url}&redirect_uri=${window.location.origin}/identify&state=${window.location.href}`);
      });
    }

    fetchDeploymentRequests() {
      return jsonFetch('/api/unstable/deployment-requests').then(_ => _.json()).then(deploymentRequests => deploymentRequests.map(_ => Object.assign(_, { productType: 'mesos' }))); // TODO: have the productType in the backend);
    }
    createDeploymentRequest(productName, version, target, comment) {
      return jsonFetch('/api/deployment-requests', { method: 'POST', body: JSON.stringify({
        productName: productName,
        version: version,
        target: target,
        comment: comment
      }) });
    }
    startDeploymentRequest(deploymentRequestId) {
      return jsonFetch(`/api/deployment-requests/${deploymentRequestId}`, { method: 'PUT' });
    }

    fetchProducts() {
      return jsonFetch('/api/products').then(_ => _.json()).then(products => products.map(_ => { return {type: 'mesos', name: _} })); // TODO: have the productType in the backend
    }
    createProduct(productName) {
      return jsonFetch('/api/products', { method: 'POST', body: JSON.stringify({name: productName}) });
    }
  };
} ());
</script>

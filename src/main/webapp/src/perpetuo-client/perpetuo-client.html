<link rel="import" href="../../bower_components/polymer/polymer.html"/>

<script>
'use strict';

this.Perpetuo = this.Perpetuo || {};
this.Perpetuo.Client = this.Perpetuo.Client || (function () {

  function memoize(f) {
    const memoized = () => {
      if (!memoized.hasOwnProperty('__cache')) {
        memoized.__cache = f();
      }
      return memoized.__cache;
    };
    return memoized;
  }

  const fetchAuthorizeURL = memoize(() => Perpetuo.Client.fetch('/api/auth/authorize-url').then(_ => _.json()).then(_ => _.url));

  return class Client {
    constructor(host) {
      this.host = host;

      this.hasMoreDeploymentRequests = undefined; // Unknown until first request
    }

    redirectToAuthorizeURL(win) {
      fetchAuthorizeURL().then(url => {
        win.location.replace(`${url}&redirect_uri=${window.location.origin}/identify&state=${window.location.href}`);
      });
    }

    identify(accessToken) {
      return Perpetuo.Client.fetch('/api/auth/identify', {method: 'POST', body: JSON.stringify({token: accessToken})}).then(_ => {
        if (_.status === 200)
          return _.text();
        throw _.statusText;
      }).then(jwt => {
        window.localStorage.jwt = jwt;
        document.cookie = 'jwt=' + window.localStorage.jwt;
      });
    }

    signOut() {
      document.cookie = 'jwt=;expires=' + new Date().toUTCString() + ";path=/";
      window.localStorage.removeItem('jwt');
    }

    fetchIdentity() {
      return Perpetuo.Client.fetch('/api/auth/identity').then(r => r.json()).then(o => o.name).catch(() => null);
    }

    fetchDeploymentRequest(id) {
      return Perpetuo.Client.fetch(`/api/unstable/deployment-requests/${id}`)
        .then(_ => _.json());
    }

    fetchDeploymentRequests(options) {
      options = Object.assign({where: [], limit: 20, offset: 0}, options);
      options.limit = options.limit + 1; // Ask for one more element to know if more are available TODO: remove
      return Perpetuo.Client.fetch('/api/unstable/deployment-requests', {method: 'POST', body: JSON.stringify(options)})
        .then(_ => _.json()).then(deploymentRequests => {
          this.hasMoreDeploymentRequests = deploymentRequests.length === options.limit; // TODO: handle in caller
          if (this.hasMoreDeploymentRequests) {
            deploymentRequests.pop();
          }
          return deploymentRequests;
        });
    }

    createDeploymentRequest(productName, version, plan, comment) {
      return Perpetuo.Client.fetch('/api/deployment-requests', {
        method: 'POST',
        body: JSON.stringify({
          productName: productName,
          version: version,
          plan: plan,
          comment: comment
        })
      });
    }
    deployDeploymentRequest(deploymentRequestId) {
      return this.actOnDeploymentRequest(deploymentRequestId, 'deploy', {});
    }

    deviseRevertPlan(deploymentRequestId) {
      return this.actOnDeploymentRequest(deploymentRequestId, 'devise-revert-plan');
    }

    revertDeploymentRequest(deploymentRequestId, body) {
      return this.actOnDeploymentRequest(deploymentRequestId, 'revert', body);
    }

    stopDeploymentRequest(deploymentRequestId) {
      return this.actOnDeploymentRequest(deploymentRequestId, 'stop', {});
    }

    actOnDeploymentRequest(deploymentRequestId, actionName, body) {
      return Perpetuo.Client.fetch(`/api/deployment-requests/${deploymentRequestId}/actions/${actionName}`, {method: 'POST', body: JSON.stringify(body)});
    }

    fetchProducts() {
      return Perpetuo.Client.fetch('/api/products').then(_ => _.json()).then(products => products.map(_ => {
        return {name: _.name, active: _.active}
      }));
    }

    static computeDeploymentRequestStatusLabel(status, lastOperationKind) {
      switch (status) {
        case 'paused':
          return status;
        case 'succeeded':
          return `${lastOperationKind}ed`;
        default:
          return (status === 'notStarted' ? '' : `${lastOperationKind} `) + status.replace(/([A-Z])/g, ' $1');
      }
    }

    static fetch(url, options) {
      return fetch(url, Object.assign({
        headers: {'Accept': 'application/json', 'Content-Type': 'application/json'},
        credentials: 'include'
      }, options || {})).then(r =>
        r.ok ? r : r.json().then(o => Promise.reject({status: r.status, detail: o}))
      );
    }

    updateProduct(name, active) {
      return Perpetuo.Client.fetch('/api/products', {
        method: 'PUT',
        body: JSON.stringify({name: name, active: active})
      });
    }
  };
}());
</script>

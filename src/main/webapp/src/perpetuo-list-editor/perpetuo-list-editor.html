<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-dropdown/iron-dropdown.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-input/paper-input-container.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-styles/shadow.html">

<dom-module id="perpetuo-list-editor">
  <template>
    <style>
    paper-listbox {
      cursor: pointer;
    }

    .chip-container {
      display: inline-flex;
    }
    .chip {
      margin: 4px 4px 4px 0;
      display: inline-flex;
      flex-direction: row;
      align-items: center;
      border-radius: 32px;
      background-color: hsl(0,0%,90%);
      display: flex;
      align-items: center;
    }
    .chip span {
      margin: 8px -4px 8px 12px;
    }
    .chip paper-icon-button {
      color: hsl(0,0%,54%);
      min-width: 40px;
      min-height: 40px;
    }

    paper-input-container input {
      all: inherit;
    }

    #dropdown {
      @apply --shadow-elevation-2dp;
    }
    </style>
    <paper-input-container always-float-label="[[selectedItems.length]]" disabled$="[[disabled]]">
      <label slot="label">[[label]]</label>
      <div slot="prefix" class="chip-container">
        <template is="dom-repeat" items="[[selectedItems]]">
          <div class="chip">
            <span>[[item]]</span>
            <paper-icon-button disabled$="[[disabled]]" icon="cancel" on-tap="removeElement" index="[[index]]"></paper-icon-button>
          </div>
        </template>
      </div>
      <iron-input slot="input"><input disabled$="[[computeInputDisabled(disabled, multi, selectedItems.*)]]" on-keydown="onInputKeyDown" value="{{filter::input}}"></input></iron-input>
    </paper-input-container>
    <div>
      <iron-dropdown id="dropdown" no-auto-focus>
        <paper-listbox id="listbox" slot="dropdown-content" on-selected-changed="select">
          <template is="dom-repeat" items="[[filteredChoices]]" initial-count="[[initialCount]]">
            <paper-item>[[item]]</paper-item>
          </template>
        </paper-listbox>
      </iron-dropdown>
    </div>
  </template>
  <script>
  (function () {
    class PerpetuoListEditor extends Polymer.Element {
      static get is() { return 'perpetuo-list-editor'; }

      static get properties() {
        return {
          disabled: Boolean,
          initialCount: Number,
          label: String,
          multi: Boolean,
          filter: String,
          choices: Array,
          filteredChoices: {type: Array, computed: 'applyFilter(choices, filter)', observer: 'completeOrSuggest'},
          selectedItems: {type: Array, value: () => [], notify: true},
          selectedItem: {type: Object, notify: true, reflectToAttribute: true, computed: 'lastSelectedItem(selectedItems.*)'}
        };
      }

      computeInputDisabled(disabled, multi, _) {
        return disabled || (!multi && 0 < this.selectedItems.length);
      }

      lastSelectedItem() {
        return this.selectedItems.length === 0 ? undefined : this.selectedItems[this.selectedItems.length - 1];
      }

      onInputKeyDown(e) {
        if (e.key === 'Backspace') {
          if (this.filter === '') {
            this.splice('selectedItems', -1, 1);
          }
        }
      }

      applyFilter(choices, filter) {
        if (choices && choices.length &&
            filter && filter.length) {
              const words = filter.toLowerCase().split(' ');
              return this.choices.filter(c => words.every(w => c.toLowerCase().includes(w)));
        }
        return [];
      }

      completeOrSuggest(e) {
        if (0 < this.filteredChoices.length) {
          this.$.dropdown.open();
        }
      }

      select(e) {
        if (e.detail.value !== null) {
          this.addElement(this.filteredChoices[e.detail.value]);
        }
      }

      addElement(value) {
        if (this.multi)
          this.push('selectedItems', value);
        else
          this.selectedItems = [value];
        this.$.listbox.select(null);
        this.$.dropdown.close();
        this.filter = '';
      }

      removeElement(e) {
        this.splice('selectedItems', e.currentTarget.index, 1);
      }

      clear() {
        this.selectedItems = [];
        this.filter = '';
      }
    }

    customElements.define(PerpetuoListEditor.is, PerpetuoListEditor);
  } ());
  </script>
</dom-module>

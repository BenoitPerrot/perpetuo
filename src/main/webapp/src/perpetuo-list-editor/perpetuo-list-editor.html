<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-dropdown/iron-dropdown.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-input/paper-input-container.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">

<dom-module id="perpetuo-list-editor">
  <template>
    <style>
    paper-listbox {
      cursor: pointer;
    }

    .chip-container {
      display: inline-flex;
    }
    .chip {
      display: inline-flex;
      flex-direction: row;
      align-items: center;
      border-radius: 32px;
      background-color: hsl(0,0%,90%);
      display: flex;
      align-items: center;
    }
    .chip span {
      margin: 8px -4px 8px 12px;
    }
    .chip paper-icon-button {
      color: hsl(0,0%,54%);
      min-width: 40px;
      min-height: 40px;
    }

    paper-input-container input {
      all: inherit;
    }
    </style>
    <paper-input-container always-float-label="[[selectedItems.length]]">
      <label slot="label">[[label]]</label>
      <div slot="prefix" class="chip-container">
        <template is="dom-repeat" items="[[selectedItems]]">
          <div class="chip">
            <span>[[item]]</span>
            <paper-icon-button icon="cancel" on-tap="removeElement" index="[[index]]"></paper-icon-button>
          </div>
        </template>
      </div>
      <iron-input slot="input"><input on-keydown="onInputKeyDown" value="{{filter::input}}"></input></iron-input>
    </paper-input-container>
    <div>
      <iron-dropdown id="dropdown" no-auto-focus>
        <paper-listbox id="listbox" slot="dropdown-content" on-selected-changed="select">
          <template is="dom-repeat" items="[[filteredChoices]]" initial-count="[[initialCount]]">
            <paper-item>[[item]]</paper-item>
          </template>
        </paper-listbox>
      </iron-dropdown>
    </div>
  </template>
  <script>
  Polymer({
    is: 'perpetuo-list-editor',

    properties: {
      initialCount: Number,
      label: String,
      multi: Boolean,
      filter: String,
      choices: Array,
      filteredChoices: {type: Array, computed: 'applyFilter(choices, filter)', observer: 'completeOrSuggest'},
      selectedItems: {type: Array, value: () => [], notify: true},
    },

    onInputKeyDown(e) {
      if (e.key === 'Backspace') {
        if (this.filter === '') {
          this.splice('selectedItems', -1, 1);
        }
      }
    },

    applyFilter(choices, filter) {
      if (choices && choices.length &&
          filter && filter.length) {
        const words = filter.toLowerCase().split(' ');
        return this.choices.filter(c => words.every(w => c.toLowerCase().includes(w)));
      }
      return [];
    },

    completeOrSuggest(e) {
      if (0 < this.filteredChoices.length) {
        if (1 < this.filteredChoices.length)
          this.$.dropdown.open();
        else
          this.addElement(this.filteredChoices[0]);
      }
    },

    select(e) {
      if (e.detail.value !== null) {
        this.addElement(this.filteredChoices[e.detail.value]);
      }
    },

    addElement(value) {
      if (this.multi)
        this.push('selectedItems', value);
      else
        this.selectedItems = [value];
      this.$.listbox.select(null);
      this.$.dropdown.close();
      this.filter = '';
    },

    removeElement(e) {
      this.splice('selectedItems', e.currentTarget.index, 1);
    }
  });
  </script>
</dom-module>

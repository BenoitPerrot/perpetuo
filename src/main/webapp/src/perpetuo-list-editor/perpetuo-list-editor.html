<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-dropdown/iron-dropdown.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">

<dom-module id="perpetuo-list-editor">
  <template>
    <style>
    paper-listbox {
      cursor: pointer;
    }

    .removable-item {
      display: inline-flex;
      flex-direction: row;
      align-items: center;
    }

    .chip {
      border-radius: 32px;
      background-color: hsl(0,0%,90%);
      display: flex;
      align-items: center;
    }
    .chip span {
      margin: 8px -4px 8px 12px;
    }
    .chip paper-icon-button {
      color: hsl(0,0%,54%);
      min-width: 40px;
      min-height: 40px;
    }
    </style>
    <paper-input id="search" label="[[label]]" value="{{filter}}" no-animations></paper-input>
    <div>
      <iron-dropdown id="dropdown" no-auto-focus>
        <paper-listbox id="listbox" slot="dropdown-content" on-selected-changed="select">
          <template is="dom-repeat" items="[[filteredChoices]]">
            <paper-item>[[item]]</paper-item>
          </template>
        </paper-listbox>
      </iron-dropdown>
    </div>
    <template is="dom-repeat" items="[[selectedItems]]">
      <div class="removable-item">
        <div class="chip">
          <span>[[item]]</span>
          <paper-icon-button icon="cancel" on-tap="removeElement" index="[[index]]"></paper-icon-button>
        </div>
      </div>
    </template>
  </template>
  <script>
  Polymer({
    is: 'perpetuo-list-editor',

    properties: {
      label: String,
      multi: Boolean,
      filter: String,
      choices: Array,
      filteredChoices: {type: Array, computed: 'narrowDown(choices, filter)'},
      selectedItems: {type: Array, value: () => [], notify: true},
    },

    narrowDown(choices, filter) {
      if (choices && choices.length) {
        if (!filter || filter.length === 0)
          this.$.dropdown.close();
        else {
          const words = filter.toLowerCase().split(' ');
          const filteredChoices = this.choices.filter(c => words.every(w => c.toLowerCase().includes(w)));
          if (0 < filteredChoices.length) {
            if (1 < filteredChoices.length)
              this.$.dropdown.open();
            else
              this.addElement(filteredChoices[0]);
          }
          return filteredChoices;
        }
      }
      return [];
    },

    select(e) {
      if (e.detail.value !== null) {
        this.addElement(this.filteredChoices[e.detail.value]);
        this.$.search.value = '';
      }
    },

    addElement(value) {
      if (this.multi)
        this.push('selectedItems', value);
      else
        this.selectedItems = [value];
      this.$.listbox.select(null);
      this.$.dropdown.close();
    },

    removeElement(e) {
      this.$.search.value = '';
      this.splice('selectedItems', e.currentTarget.index, 1);
    }
  });
  </script>
</dom-module>

<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/social-icons.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-styles/shadow.html">

<link rel="import" href="../perpetuo-identity/perpetuo-identity.html">

<dom-module id="perpetuo-app-toolbar">
  <template>
    <style>
    app-toolbar {
      background-color: #0086b2;
      color: #fff;
      font-size: 16pt;
    }
    paper-icon-button {
      --paper-icon-button-ink-color: white;
    }
    paper-icon-button + [main-title] {
      margin-left: 24px;
    }
    span.pageTitle {
      text-transform: capitalize;
    }
    #identityContainer {
      position: relative;
    }
    #identityContainer paper-button iron-icon {
      padding-right: 8px;
    }
    #identityContainer paper-button span {
      text-transform: initial;
    }
    #identityContainer #signOutContainer[hidden] {
      display: none;
    }
    #identityContainer #signOutContainer {
      position: absolute;
      width: 100%;
      background-color: #fff;
      color: #757575;
      @apply --shadow-elevation-2dp;
    }
    </style>
    <perpetuo-identity id="identity" login="{{login}}"></perpetuo-identity>
    <app-toolbar>
      <paper-icon-button icon="menu" on-tap="fireDrawerToggleTap"></paper-icon-button>
      <div main-title><span>Perpetuo</span><span hidden$="[[!pageTitle]]" class="pageTitle"> / [[pageTitle]]</span></div>
      <div id="identityContainer">
        <paper-button style="min-width: 0;" on-tap="onIdentityTap"><iron-icon icon="social:person"></iron-icon><span>[[login]]</span></paper-button>
        <iron-collapse id="signOutContainer" hidden="[[!login]]">
          <paper-button on-tap="onSignOutTap"><iron-icon icon="exit-to-app"></iron-icon><span>Sign out</span></paper-button>
        </iron-collapse>
      </div>
    </app-toolbar>
  </template>
  <script>
  (function () {
    function isChildOf(n, parent) {
      while (n) {
        if (n.parentElement === parent)
          return true;
        n = n.parentElement;
      }
      return false;
    }

    class PerpetuoAppToolbar extends Polymer.Element {
      static get is() { return 'perpetuo-app-toolbar'; }

      static get properties() {
        return {
          pageTitle: String,
          login: { type: String, notify: true }
        }
      }

      ready() {
        super.ready();
        const closeOnOutsideTap = tapEvent => {
          if (!isChildOf(tapEvent.detail.sourceEvent.target, this.$.identityContainer)) {
            this.$.signOutContainer.hide();
          }
        };
        this.$.signOutContainer.addEventListener('opened-changed', valueChangedEvent => {
          if (valueChangedEvent.detail.value) {
            document.addEventListener('tap', closeOnOutsideTap);
          } else {
            document.removeEventListener('tap', closeOnOutsideTap);
          }
        });
      }

      fireDrawerToggleTap() {
        this.dispatchEvent(new CustomEvent('drawer-toggle-tap'));
      }

      onIdentityTap() {
        if (this.login)
          this.$.signOutContainer.toggle();
        else
          this.$.identity.request();
      }

      onSignOutTap() {
        this.$.identity.signOut();
        this.$.signOutContainer.opened = false;
      }
    }

    customElements.define(PerpetuoAppToolbar.is, PerpetuoAppToolbar);
  } ());
  </script>
</dom-module>

<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">

<link rel="import" href="../perpetuo-app/perpetuo-app-drawer.html">
<link rel="import" href="../perpetuo-client/perpetuo-client.html">
<link rel="import" href="../perpetuo-identity/perpetuo-identity.html">
<link rel="import" href="../perpetuo-deployment-request/perpetuo-deployment-request.html">
<link rel="import" href="../perpetuo-deployment-request/perpetuo-deployment-request-creation-page.html">
<link rel="import" href="../perpetuo-deployment-request/perpetuo-deployment-request-table.html">
<link rel="import" href="../perpetuo-product/perpetuo-products-page.html">

<dom-module id="perpetuo-app">
  <template>
    <style is="custom-style">
    :host {
      flex: 1;
    }
    </style>

    <perpetuo-identity id="identity" login="{{login}}"></perpetuo-identity>

    <app-location route="{{route}}"></app-location>

    <iron-pages id="pageSelector" selected="[[selectPage(route)]]" attr-for-selected="page-route" selected-attribute="active" on-drawer-toggle-tap="toggleDrawer">
      <perpetuo-deployment-request-table page-route="/deployment-requests"></perpetuo-deployment-request-table>
      <perpetuo-deployment-request-creation-page page-route="/deployment-requests/new" deployment-request-id="[[routeData.id]]"></perpetuo-deployment-request-creation-page>
      <perpetuo-deployment-request page-route="/deployment-requests/:id" deployment-request-id="[[routeData.id]]"></perpetuo-deployment-request>
      <perpetuo-products-page page-route="/products"></perpetuo-products-page>
    </iron-pages>

    <perpetuo-app-drawer id="drawer"></perpetuo-app-drawer>

  </template>

  <script>
  (function () {
    class PerpetuoApp extends Polymer.Element {
      static get is() { return 'perpetuo-app'; }

      static get properties() {
        return {
          route: Object,
          routeData: { type: Object, value: () => ({}) },
          subroute: Object,
          subrouteData: Object
        };
      }

      constructor() {
        super();

        const versionRefreshPeriodInMs = 60 * 1000;
        const refreshVersion = _ => {
          fetch('/api/version').then(_ => _.text()).then(version => {
            if (window.localStorage.version !== version) {
              // TODO: Remove <<
              if (!window.localStorage.version || window.localStorage.version < 14838) {
                new Perpetuo.Client().signOut();
              }
              // >>
              window.localStorage.version = version;
              document.location.reload(true);
            }
          })
        };
        refreshVersion();
        setInterval(refreshVersion, versionRefreshPeriodInMs);
      }

      selectPage(route) {
        const routingTable = [
          {
            re: new RegExp('^/deployment-requests/(\\d+)'),
            f: (match) => {
              const id = match[1];
              this.routeData = { id: id };
              return '/deployment-requests/:id';
            }
          },
          {
            re: new RegExp('^/deployment-requests/new$'),
            f: (match) => {
              return '/deployment-requests/new';
            }
          },
          {
            re: new RegExp('^/deployment-requests/?$'),
            f: (match) => {
              return '/deployment-requests';
            }
          },
          {
            re: new RegExp('^/products/?$'),
            f: (match) => {
              return '/products';
            }
          },
          {
            re: new RegExp('^/identify'),
            f: (match) => {
              this.$.identity.acknowledge();
              return '';
            }
          },
        ];

        const page = routingTable.reduce((acc, routing) => {
          if (acc === null) {
            const m = route.path.match(routing.re);
            if (m) {
              return routing.f(m);
            }
          }
          return acc;
        }, null);
        // TODO: Have an error page for invalid routes, have a main page <<
        if (page === null) {
          return '/deployment-requests';
        }
        // >>
        return page;
      }

      toggleDrawer() {
        this.$.drawer.toggle();
      }
    }

    customElements.define(PerpetuoApp.is, PerpetuoApp);
  } ());
  </script>
</dom-module>

<link rel="import" href="../../bower_components/polymer/polymer.html"/>

<link rel="import" href="../perpetuo-client/perpetuo-client.html">

<dom-module id="perpetuo-identity">
  <template>
    <style>
    :host {
      display: none;
    }
    </style>
  </template>
  <script>
  (function () {
    class PerpetuoIdentity extends Polymer.Element {
      static get is() { return 'perpetuo-identity'; }

      static get properties() {
        return {
          login: { type: String, notify: true, readOnly: true }
        };
      }

      constructor() {
        super();

        this.client = new Perpetuo.Client();
      }

      connectedCallback() {
        super.connectedCallback();

        this.client.fetchIdentity().then(login => {
          this._setLogin(login);
        });
      }

      acknownledge() {
        const query = window.location.hash.slice(1).split('&').reduce((m, p) => {
          const kv = p.split('=');
          return m.set(kv[0], kv[1]);
        }, new Map());

        this.client.identify(query.get('access_token')).then(() => {
          window.location.replace(decodeURIComponent(query.get('state')));
        });
      }

      request() {
        this.client.redirectToAuthorizeURL(window);
      }
    }

    customElements.define(PerpetuoIdentity.is, PerpetuoIdentity);
  } ());
  </script>
</dom-module>

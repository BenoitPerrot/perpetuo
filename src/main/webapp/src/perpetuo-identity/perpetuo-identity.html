<link rel="import" href="../../bower_components/polymer/polymer.html"/>

<link rel="import" href="../perpetuo-client/perpetuo-client.html">

<dom-module id="perpetuo-identity">
  <script>
  Polymer({
    is: 'perpetuo-identity',

    properties: {
      login: { type: String, notify: true, readOnly: true }
    },

    created() {
      this.client = new Perpetuo.Client();
    },

    attached() {
      this.client.fetchIdentity().then(login => {
        this._setLogin(login);
      });
    },

    identify() {
      const query = window.location.hash.slice(1).split('&').reduce((m, p) => {
        const kv = p.split('=');
        return m.set(kv[0], kv[1]);
      }, new Map());

      this.client.identify(query.get('access_token')).then(() => {
        window.location.replace(decodeURIComponent(query.get('state')));
      });
    }
  })
  </script>
</dom-module>
